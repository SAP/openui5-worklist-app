/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./SinglePlanningCalendarUtilities","sap/ui/core/Control","sap/ui/core/LocaleData","sap/ui/core/Locale","sap/ui/core/InvisibleText","sap/ui/core/format/DateFormat","sap/ui/core/format/TimezoneUtil","sap/ui/core/Core","sap/ui/core/date/UniversalDate","sap/ui/core/dnd/DragDropInfo","sap/ui/unified/library","sap/ui/unified/calendar/DatesRow","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/unified/DateTypeRange","sap/ui/events/KeyCodes","./SinglePlanningCalendarGridRenderer","sap/ui/core/delegate/ItemNavigation","sap/ui/thirdparty/jquery","./PlanningCalendarLegend","sap/ui/core/InvisibleMessage","sap/ui/core/library","sap/ui/core/Configuration"],function(t,e,a,i,n,o,r,s,p,l,g,d,u,c,h,m,f,D,_,A,C,v,y){"use strict";var S=4.3125,T=3,R=2.125,M=1.5625,H=36e5/2,P=60*1e3,b=.4375,w=0,E=24,I=v.InvisibleMessageMode;var B=e.extend("sap.m.SinglePlanningCalendarGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},startHour:{type:"int",group:"Data",defaultValue:0},endHour:{type:"int",group:"Data",defaultValue:24},fullDay:{type:"boolean",group:"Data",defaultValue:true},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsResize:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsCreate:{type:"boolean",group:"Misc",defaultValue:false},scaleFactor:{type:"float",group:"Data",defaultValue:1}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},_columnHeaders:{type:"sap.ui.unified.calendar.DatesRow",multiple:false,visibility:"hidden"},_intervalPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}},_blockersPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},dnd:true,associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentResize:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"}}},appointmentCreate:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}}}},renderer:f});B.prototype.init=function(){var t=new Date,e=new d(this.getId()+"-columnHeaders",{showDayNamesLine:false,showWeekNumbers:false,startDate:t}).addStyleClass("sapMSinglePCColumnHeader"),a=(60-t.getSeconds())*1e3,i=this._getCoreLocaleData().getTimePattern("medium");e._setAriaRole("columnheader");this.setAggregation("_columnHeaders",e);this.setStartDate(t);this._setColumns(7);this._configureBlockersDragAndDrop();this._configureAppointmentsDragAndDrop();this._configureAppointmentsResize();this._configureAppointmentsCreate();this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatStartEndInfoAria=o.getDateTimeInstance({pattern:"EEEE dd/MM/yyyy 'at' "+i});this._oFormatAriaFullDayCell=o.getDateTimeInstance({pattern:"EEEE dd/MM/yyyy"});this._sLegendId=undefined;setTimeout(this._updateRowHeaderAndNowMarker.bind(this),a)};B.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation}};B.prototype.onBeforeRendering=function(){var t=this._createAppointmentsMap(this.getAppointments()),e=this.getStartDate(),a=u.fromLocalJSDate(e),i=this._getColumns();this._oVisibleAppointments=this._calculateVisibleAppointments(t.appointments,this.getStartDate(),i);this._oAppointmentsToRender=this._calculateAppointmentsLevelsAndWidth(this._oVisibleAppointments);this._aVisibleBlockers=this._calculateVisibleBlockers(t.blockers,a,i);this._oBlockersToRender=this._calculateBlockersLevelsAndWidth(this._aVisibleBlockers);if(this._iOldColumns!==i||this._oOldStartDate!==e){this._createBlockersDndPlaceholders(e,i);this._createAppointmentsDndPlaceholders(e,i)}this._oInvisibleMessage=C.getInstance()};B.prototype.onmousedown=function(t){var e=t.target.classList;this._isResizeHandleBottomMouseDownTarget=e.contains("sapMSinglePCAppResizeHandleBottom");this._isResizeHandleTopMouseDownTarget=e.contains("sapMSinglePCAppResizeHandleTop")};B.prototype._isResizingPerformed=function(){return this._isResizeHandleBottomMouseDownTarget||this._isResizeHandleTopMouseDownTarget};B.prototype._configureBlockersDragAndDrop=function(){this.addDragDropConfig(new l({sourceAggregation:"appointments",targetAggregation:"_blockersPlaceholders",dragStart:function(t){if(!this.getEnableAppointmentsDragAndDrop()){t.preventDefault();return false}var e=function(){var t=_(".sapMSinglePCOverlay");setTimeout(function(){t.addClass("sapMSinglePCOverlayDragging")});_(document).one("dragend",function(){t.removeClass("sapMSinglePCOverlayDragging")})};e()}.bind(this),dragEnter:function(t){var e=t.getParameter("dragSession"),a=e.getDragControl(),i=e.getDropControl(),n=this.isAllDayAppointment(a._getStartDateWithTimezoneAdaptation(),a._getEndDateWithTimezoneAdaptation()),o=function(){var t=_(e.getIndicator()),o=a.$().outerHeight(),r=a.$().outerWidth(),s=i.$().closest(".sapMSinglePCBlockersColumns").get(0).getBoundingClientRect(),p=i.getDomRef().getBoundingClientRect(),l=p.left+r-(s.left+s.width);if(n){t.css("min-height",o);t.css("min-width",Math.min(r,r-l))}else{t.css("min-height",e.getDropControl().$().outerHeight());t.css("min-width",e.getDropControl().$().outerWidth())}};if(!e.getIndicator()){setTimeout(o,0)}else{o()}}.bind(this),drop:function(t){var e=t.getParameter("dragSession"),a=e.getDragControl(),i=e.getDropControl(),n=i.getDate().getJSDate(),o,r=t.getParameter("browserEvent"),s=r.metaKey||r.ctrlKey,p=this.isAllDayAppointment(a._getStartDateWithTimezoneAdaptation(),a._getEndDateWithTimezoneAdaptation());o=new Date(n);if(p){o.setMilliseconds(a._getEndDateWithTimezoneAdaptation().getTime()-a._getStartDateWithTimezoneAdaptation().getTime())}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(p&&a._getStartDateWithTimezoneAdaptation().getTime()===n.getTime()){return}this.fireAppointmentDrop({appointment:a,startDate:n,endDate:o,copy:s})}.bind(this)}))};B.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new l({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(t){if(!this.getEnableAppointmentsDragAndDrop()||this._isResizingPerformed()){t.preventDefault();return false}var e=function(){var t=_(".sapMSinglePCOverlay");setTimeout(function(){t.addClass("sapMSinglePCOverlayDragging")});_(document).one("dragend",function(){t.removeClass("sapMSinglePCOverlayDragging")})};e()}.bind(this),dragEnter:function(t){var e=t.getParameter("dragSession"),a=e.getDragControl(),i=e.getDropControl(),n=this.isAllDayAppointment(a._getStartDateWithTimezoneAdaptation(),a._getEndDateWithTimezoneAdaptation()),o=function(){var t=_(e.getIndicator()),o=a.$().outerHeight(),r=i.$().closest(".sapMSinglePCColumn").get(0).getBoundingClientRect(),s=e.getDropControl().getDomRef().getBoundingClientRect(),p=s.top+o-(r.top+r.height);if(n){t.css("min-height",2*e.getDropControl().$().outerHeight())}else{t.css("min-height",Math.min(o,o-p))}};if(!e.getIndicator()){setTimeout(o,0)}else{o()}}.bind(this),drop:function(t){var e=t.getParameter("dragSession"),a=e.getDragControl(),i=e.getDropControl(),n=i.getDate().getJSDate(),o,r=t.getParameter("browserEvent"),s=r.metaKey||r.ctrlKey,p=this.isAllDayAppointment(a._getStartDateWithTimezoneAdaptation(),a._getEndDateWithTimezoneAdaptation());o=new Date(n);if(p){o.setHours(o.getHours()+1)}else{o.setMilliseconds(a._getEndDateWithTimezoneAdaptation().getTime()-a._getStartDateWithTimezoneAdaptation().getTime())}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(!p&&a._getStartDateWithTimezoneAdaptation().getTime()===n.getTime()){return}this.fireAppointmentDrop({appointment:a,startDate:n,endDate:o,copy:s})}.bind(this)}))};B.prototype._configureAppointmentsResize=function(){var t=new l({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(t){if(!this.getEnableAppointmentsResize()||!this._isResizingPerformed()){t.preventDefault();return}var e=t.getParameter("dragSession"),a=e.getDragControl(),i=t.getParameter("browserEvent")&&t.getParameter("browserEvent").target||null;a._sAppointmentPartSuffix=i&&i.id?i.id.replace(a.getId()+"-",""):"";var n=this.$().find(".sapMSinglePCOverlay"),o=_(e.getIndicator()),r=a.$();if(this._isResizeHandleBottomMouseDownTarget){e.setComplexData("bottomHandle","true")}if(this._isResizeHandleTopMouseDownTarget){e.setComplexData("topHandle","true")}o.addClass("sapUiDnDIndicatorHide");setTimeout(function(){n.addClass("sapMSinglePCOverlayDragging")},0);_(document).one("dragend",function(){var t=e.getComplexData("appointmentStartingBoundaries");n.removeClass("sapMSinglePCOverlayDragging");o.removeClass("sapUiDnDIndicatorHide");r.css({top:t.top,height:t.height,"z-index":"auto",opacity:1})});t.getParameter("browserEvent").dataTransfer.setDragImage(z(),0,0)}.bind(this),dragEnter:function(t){var e=t.getParameter("dragSession"),a=e.getDragControl().$().get(0),i=e.getDropControl().getDomRef(),n=e.getComplexData("appointmentStartingBoundaries"),o=function(){var t=_(e.getIndicator());t.addClass("sapUiDnDIndicatorHide")},r,s,p,l,g;if(!n){n={top:a.offsetTop,bottom:a.offsetTop+a.getBoundingClientRect().height,height:a.getBoundingClientRect().height};e.setComplexData("appointmentStartingBoundaries",n)}l=e.getData("bottomHandle")?n.top:n.bottom;r=Math.min(l,i.offsetTop);s=Math.max(l,i.offsetTop+i.getBoundingClientRect().height);p=s-r;g={top:r,height:p,"z-index":1,opacity:.8};e.getDragControl().$().css(g);if(!e.getIndicator()){setTimeout(o,0)}else{o()}},drop:function(t){var e=t.getParameter("dragSession"),a=e.getDragControl(),i=this.indexOfAggregation("_intervalPlaceholders",e.getDropControl()),n=e.getComplexData("appointmentStartingBoundaries"),o;o=this._calcResizeNewHoursAppPos(a._getStartDateWithTimezoneAdaptation(),a._getEndDateWithTimezoneAdaptation(),i,e.getComplexData("bottomHandle"));this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");_(e.getIndicator()).removeClass("sapUiDnDIndicatorHide");a.$().css({top:n.top,height:n.height,"z-index":"auto",opacity:1});if(a._getEndDateWithTimezoneAdaptation().getTime()===o.endDate.getTime()&&a._getStartDateWithTimezoneAdaptation().getTime()===o.startDate.getTime()){return}this.fireAppointmentResize({appointment:a,startDate:o.startDate,endDate:o.endDate});setTimeout(function(){this.invalidate()}.bind(this),0)}.bind(this)});this.addDragDropConfig(t)};B.prototype._configureAppointmentsCreate=function(){this.addDragDropConfig(new l({targetAggregation:"_intervalPlaceholders",dragStart:function(t){if(!this.getEnableAppointmentsCreate()){t.preventDefault();return}var e=t.getParameter("browserEvent");var a=this.$().find(".sapMSinglePCOverlay");setTimeout(function(){a.addClass("sapMSinglePCOverlayDragging")});_(document).one("dragend",function(){a.removeClass("sapMSinglePCOverlayDragging");_(".sapUiAppCreate").remove();_(".sapUiDnDDragging").removeClass("sapUiDnDDragging")});e.dataTransfer.setDragImage(z(),0,0);var i=t.getParameter("target"),n=i.getAggregation("_intervalPlaceholders"),o=n[0].getDomRef().getBoundingClientRect(),r=o.height,s=Math.floor((o.top-i.getDomRef().getBoundingClientRect().top)/r),p=t.getParameter("dragSession"),l=Math.floor(e.offsetY/r)-s,g,d;if(this._iColumns===1){g=l}else{var u=64,c=2,h=Math.floor(n[0].getDomRef().getBoundingClientRect().width)-c,m=Math.floor(Math.floor(e.offsetX-u)/h),f=n.length/this._iColumns;g=l+m*f}if(g<0){g=0}d=n[g].getDomRef().getBoundingClientRect();p.setComplexData("startingRectsDropArea",{top:Math.ceil(l*r),left:d.left});p.setComplexData("startingDropDate",n[g].getDate())}.bind(this),dragEnter:function(t){var e=t.getParameter("dragSession"),a=e.getDropControl(),i=a.getDomRef(),n=i.offsetHeight,o=i.offsetTop,r=o,s=i.getBoundingClientRect().left,p=s,l=a.$().parents(".sapMSinglePCColumn").get(0),g=_(".sapUiAppCreate");if(!g.get(0)){g=_("<div></div>").addClass("sapUiCalendarApp sapUiCalendarAppType01 sapUiAppCreate");g.appendTo(l)}_(".sapUiDnDDragging").removeClass("sapUiDnDDragging");if(!e.getComplexData("startingRectsDropArea")){e.setComplexData("startingRectsDropArea",{top:o,left:s});e.setComplexData("startingDropDate",a.getDate())}else{r=e.getComplexData("startingRectsDropArea").top;p=e.getComplexData("startingRectsDropArea").left}if(s!==p){t.preventDefault();return false}a.$().closest(".sapMSinglePCColumn").find(".sapMSinglePCAppointments").addClass("sapUiDnDDragging");g.css({top:Math.min(r,o)+2,height:Math.abs(r-o)+n-4,left:3,right:3,"z-index":2});e.setIndicatorConfig({display:"none"})},drop:function(t){var e=t.getParameter("dragSession"),a=e.getDropControl(),i=60/(this.getScaleFactor()*2)*60*1e3,n=e.getComplexData("startingDropDate").getTime(),o=a.getDate().getJSDate().getTime(),r=Math.min(n,o),s=Math.max(n,o)+i;this.fireAppointmentCreate({startDate:new Date(r),endDate:new Date(s)});_(".sapUiAppCreate").remove();_(".sapUiDnDDragging").removeClass("sapUiDnDDragging")}.bind(this)}))};B.prototype._calcResizeNewHoursAppPos=function(t,e,a,i){var n=60/(this.getScaleFactor()*2)*60*1e3,o=this.getAggregation("_intervalPlaceholders")[a].getDate().getTime(),r=o+n,s=i?t.getTime():e.getTime(),p=Math.min(s,o),l=Math.max(s,r);return{startDate:new Date(p),endDate:new Date(l)}};B.prototype._adjustAppointmentsHeightforCompact=function(t,e,a,i){var n,o,r,s,p,l,g,d,u=this._getRowHeight(),c=0,h=.125,m=.125,f=.0625,D=this.getScaleFactor(),_=2*D;if(this._oAppointmentsToRender[t]){this._oAppointmentsToRender[t].oAppointmentsList.getIterator().forEach(function(t){n=t.getData();o=this.getDomRef().querySelector("#"+n.getId()+"-"+i+"_"+c);r=n._getStartDateWithTimezoneAdaptation();s=n._getEndDateWithTimezoneAdaptation();g=e.getTime()>r.getTime();d=a.getTime()<s.getTime();p=g?0:this._calculateTopPosition(r);l=d?0:this._calculateBottomPosition(s);o.style["top"]=p+"rem";o.style["bottom"]=l+"rem";o.querySelector(".sapUiCalendarApp").style["minHeight"]=(u-(h+m+f)*D)/_+"rem";++c}.bind(this))}};B.prototype._adjustBlockersHeightforCompact=function(){var t=this._getBlockersToRender().iMaxlevel,e=(t+1)*this._getBlockerRowHeight(),a=this._getColumns()===1?e+b:e,i=this._getBlockerRowHeight();if(t>0){a=a+.1875}this.$().find(".sapMSinglePCBlockersColumns").css("height",a+"rem");this._oBlockersToRender.oBlockersList.getIterator().forEach(function(t){t.getData().$().css("top",i*t.level+.0625+"rem")})};B.prototype._adjustBlockersHeightforCozy=function(){var t=this._getBlockersToRender()&&this._getBlockersToRender().iMaxlevel,e;if(this._getColumns()===1){e=(t+1)*this._getBlockerRowHeight();this.$().find(".sapMSinglePCBlockersColumns").css("height",e+b+"rem")}};B.prototype._adjustRowHigth=function(){this.$().find(".sapMSinglePCRow").css("height",this._getRowHeight()+"rem")};B.prototype.onAfterRendering=function(){var t=this._getColumns(),e=this.getStartDate(),a=this._getRowHeight();if(a===T){for(var i=0;i<t;i++){var n=new u(e.getFullYear(),e.getMonth(),e.getDate()+i),o=this._getDateFormatter().format(n.toLocalJSDate()),r=new p(n.getYear(),n.getMonth(),n.getDate(),this._getVisibleStartHour()),s=new p(n.getYear(),n.getMonth(),n.getDate(),this._getVisibleEndHour(),59,59);this._adjustAppointmentsHeightforCompact(o,r,s,i)}this._adjustBlockersHeightforCompact()}else{this._adjustBlockersHeightforCozy()}this._adjustRowHigth();this._updateRowHeaderAndNowMarker();L.call(this)};B.prototype._appFocusHandler=function(t,e){var a=sap.ui.getCore().byId(t.target.id)||this._findSrcControl(t);if(a&&a.isA("sap.ui.unified.CalendarAppointment")){this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)});this._focusCellWithKeyboard(a,e);t.preventDefault()}};B.prototype._cellFocusHandler=function(t,e){var a=t.target,i=this._getDateFormatter(),n;if(a.classList.contains("sapMSinglePCRow")||a.classList.contains("sapMSinglePCBlockersColumn")){n=i.parse(a.getAttribute("data-sap-start-date"));if(this._isBorderReached(n,e)){this.fireEvent("borderReached",{startDate:n,next:e===m.ARROW_RIGHT,fullDay:a.classList.contains("sapMSinglePCBlockersColumn")})}}};B.prototype.onsapup=function(t){this._appFocusHandler(t,m.ARROW_UP)};B.prototype.onsapdown=function(t){this._appFocusHandler(t,m.ARROW_DOWN)};B.prototype.onsapright=function(t){this._appFocusHandler(t,m.ARROW_RIGHT);this._cellFocusHandler(t,m.ARROW_RIGHT)};B.prototype.onsapleft=function(t){this._appFocusHandler(t,m.ARROW_LEFT);this._cellFocusHandler(t,m.ARROW_LEFT)};B.prototype.setStartDate=function(t){this._oOldStartDate=this.getStartDate();this.getAggregation("_columnHeaders").setStartDate(t);return this.setProperty("startDate",t)};B.prototype.applyFocusInfo=function(t){var e=this._getVisibleBlockers(),a=this._getVisibleAppointments(),i=Object.keys(a),n,o,r;if(this._sSelectedAppointment){this._sSelectedAppointment.focus();return this}for(o=0;o<e.length;++o){if(e[o].getId()===t.id){e[o].focus();return this}}for(o=0;o<i.length;++o){n=a[i[o]];for(r=0;r<n.length;++r){if(n[r].getId()===t.id){n[r].focus();return this}}}return this};B.prototype.getSelectedAppointments=function(){return this.getAppointments().filter(function(t){return t.getSelected()})};B.prototype._toggleAppointmentSelection=function(t,e){var a=[],i=t&&t.getDomRef(),n,o,r;if(e){n=this.getAppointments();for(r=0,o=n.length;r<o;r++){if((!t||n[r].getId()!==t.getId())&&n[r].getSelected()){n[r].setProperty("selected",false);a.push(n[r])}}}if(t){t.setProperty("selected",!t.getSelected());a.push(t);this._sSelectedAppointment=t.getSelected()&&i?t:undefined}else{this._sSelectedAppointment=undefined}return a};B.prototype._isBorderReached=function(t,e){var a=u.fromLocalJSDate(this.getStartDate()),i=new u(a.getYear(),a.getMonth(),a.getDate()+this._getColumns()-1),n=u.fromLocalJSDate(t),o=e===m.ARROW_LEFT&&n.isSame(a),r=e===m.ARROW_RIGHT&&n.isSame(i);return o||r};B.prototype._focusCellWithKeyboard=function(t,e){var a=this.isAllDayAppointment(t._getStartDateWithTimezoneAdaptation(),t._getEndDateWithTimezoneAdaptation()),i=this._getDateFormatter(),n=new Date(t._getStartDateWithTimezoneAdaptation().getFullYear(),t._getStartDateWithTimezoneAdaptation().getMonth(),t._getStartDateWithTimezoneAdaptation().getDate(),t._getStartDateWithTimezoneAdaptation().getHours()),o=new Date(this.getStartDate().getFullYear(),this.getStartDate().getMonth(),this.getStartDate().getDate(),this.getStartDate().getHours());if(n<o){n=o}if(this._isBorderReached(n,e)){this.fireEvent("borderReached",{startDate:n,next:e===m.ARROW_RIGHT,fullDay:a});return}switch(e){case m.ARROW_UP:if(!a){n.setHours(n.getHours()-1)}break;case m.ARROW_DOWN:if(!a){n.setHours(n.getHours()+1)}break;case m.ARROW_LEFT:n.setDate(n.getDate()-1);break;case m.ARROW_RIGHT:n.setDate(n.getDate()+1);break;default:}if(a&&e!==m.ARROW_DOWN){_("[data-sap-start-date='"+i.format(n)+"'].sapMSinglePCBlockersColumn").trigger("focus")}else{_("[data-sap-start-date='"+i.format(n)+"'].sapMSinglePCRow").trigger("focus")}};B.prototype.ontap=function(t){this._fireSelectionEvent(t)};B.prototype.onkeydown=function(t){if(t.which===m.SPACE||t.which===m.ENTER){this._fireSelectionEvent(t);var e=this._findSrcControl(t);if(e&&e.isA("sap.ui.unified.CalendarAppointment")){var a=e.getSelected()?"APPOINTMENT_SELECTED":"APPOINTMENT_UNSELECTED";this._oInvisibleMessage.announce(this._oUnifiedRB.getText(a),I.Polite)}t.preventDefault()}};B.prototype._findSrcControl=function(t){var e=t.target,a=e.parentElement,i;if(!a){return t.srcControl}else if(a.classList.contains("sapUiCalendarRowApps")){i=a.getAttribute("data-sap-ui-related")||a.id}else{i=e.getAttribute("data-sap-ui-related")||e.id}return this.getAppointments().find(function(t){return t.sId===i})};B.prototype._fireSelectionEvent=function(t){var e=this._findSrcControl(t),a=t.target;if(t.target.classList.contains("sapMSinglePCRow")||t.target.classList.contains("sapMSinglePCBlockersColumn")){this.fireEvent("cellPress",{startDate:this._getDateFormatter().parse(a.getAttribute("data-sap-start-date")),endDate:this._getDateFormatter().parse(a.getAttribute("data-sap-end-date"))});this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)})}else if(e&&e.isA("sap.ui.unified.CalendarAppointment")){if(a.parentElement&&a.parentElement.getAttribute("id")){var i=a.parentElement.getAttribute("id");var n=a.parentElement.getAttribute("data-sap-ui-related");var o=i.replace(n+"-","");e._setAppointmentPartSuffix(o)}this.fireAppointmentSelect({appointment:e,appointments:this._toggleAppointmentSelection(e,!(t.ctrlKey||t.metaKey))})}};B.prototype._getVisibleStartHour=function(){return this.getFullDay()||!this.getStartHour()?w:this.getStartHour()};B.prototype._getVisibleEndHour=function(){return(this.getFullDay()||!this.getEndHour()?E:this.getEndHour())-1};B.prototype._isVisibleHour=function(t){var e=this.getStartHour(),a=this.getEndHour();if(!this.getStartHour()){e=w}if(!this.getEndHour()){a=E}if(e>a){return e<=t||t<a}return e<=t&&t<a};B.prototype._shouldHideRowHeader=function(t){var e=(new Date).getHours(),a=c._areCurrentMinutesLessThan(15)&&e===t,i=c._areCurrentMinutesMoreThan(45)&&e===t-1;return a||i};B.prototype._parseDateStringAndHours=function(t,e){var a=this._getDateFormatter().parse(t);if(e){a.setHours(e)}return a};B.prototype._getDateFormatter=function(){if(!(this._oDateFormat instanceof o)){this._oDateFormat=o.getDateTimeInstance({pattern:"yyyyMMdd-HHmm"})}return this._oDateFormat};B.prototype._formatTimeAsString=function(t){var e=this._getHoursPattern()+":mm",a=o.getTimeInstance({pattern:e},new i(this._getCoreLocaleId()));return a.format(t)};B.prototype._addAMPM=function(t){var e=this._getAMPMFormat();return" "+e.format(t)};B.prototype._calculateTopPosition=function(t){var e=t.getHours()-this._getVisibleStartHour(),a=t.getMinutes(),i=this._getRowHeight();return i*e+i/60*a};B.prototype._calculateBottomPosition=function(t){var e=this._getVisibleEndHour()+1-t.getHours(),a=t.getMinutes(),i=this._getRowHeight();return i*e-i/60*a};B.prototype._updateRowHeaderAndNowMarker=function(){var t=new Date;this._updateNowMarker(t);this._updateRowHeaders(t);setTimeout(this._updateRowHeaderAndNowMarker.bind(this),P)};B.prototype._updateNowMarker=function(t){var e=this.$("nowMarker"),a=this.$("nowMarkerText"),i=this.$("nowMarkerAMPM"),n=!this._isVisibleHour(t.getHours()),o=new Date(t.getTime());o=this._convertToTimezone(o);e.toggleClass("sapMSinglePCNowMarkerHidden",n);e.css("top",this._calculateTopPosition(o)+"rem");a.text(this._formatTimeAsString(t));i.text(this._addAMPM(t));a.append(i)};B.prototype._convertToTimezone=function(t){var e=s.getConfiguration().getTimezone();var a=c._createUniversalUTCDate(t,undefined,true);a=new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds());a.setUTCFullYear(t.getUTCFullYear());a=r.convertToTimezone(a,e);return a};B.prototype._updateRowHeaders=function(t){var e=this.$(),a=t.getHours(),i=a+1;e.find(".sapMSinglePCRowHeader").removeClass("sapMSinglePCRowHeaderHidden");if(this._shouldHideRowHeader(a)){e.find(".sapMSinglePCRowHeader"+a).addClass("sapMSinglePCRowHeaderHidden")}else if(this._shouldHideRowHeader(i)){e.find(".sapMSinglePCRowHeader"+i).addClass("sapMSinglePCRowHeaderHidden")}};B.prototype._createAppointmentsMap=function(t){var e=this;return t.reduce(function(t,a){var i=a._getStartDateWithTimezoneAdaptation(),n=a._getEndDateWithTimezoneAdaptation(),o,r,s;if(!i||!n){return t}if(!e.isAllDayAppointment(i,n)){o=u.fromLocalJSDate(i);r=u.fromLocalJSDate(n);while(o.isSameOrBefore(r)){s=e._getDateFormatter().format(o.toLocalJSDate());if(!t.appointments[s]){t.appointments[s]=[]}t.appointments[s].push(a);o.setDate(o.getDate()+1)}}else{t.blockers.push(a)}return t},{appointments:{},blockers:[]})};B.prototype._calculateVisibleAppointments=function(t,e,a){var i={},n,o,r;for(var s=0;s<a;s++){n=new u(e.getFullYear(),e.getMonth(),e.getDate()+s);o=this._getDateFormatter().format(n.toLocalJSDate());r=this._isAppointmentFitInVisibleHours(n);if(t[o]){i[o]=t[o].filter(r,this).sort(this._sortAppointmentsByStartHourCallBack)}}return i};B.prototype._isAppointmentFitInVisibleHours=function(t){return function(e){var a=e._getStartDateWithTimezoneAdaptation().getTime(),i=e._getEndDateWithTimezoneAdaptation().getTime(),n=new p(t.getYear(),t.getMonth(),t.getDate(),this._getVisibleStartHour()).getTime(),o=new p(t.getYear(),t.getMonth(),t.getDate(),this._getVisibleEndHour(),59,59).getTime();var r=a<n&&i>o,s=a>=n&&a<o,l=i>n&&i<=o;return r||s||l}};B.prototype._calculateAppointmentsLevelsAndWidth=function(e){var a=H-(this.getScaleFactor()-1)*5*60*1e3;var i=this;return Object.keys(e).reduce(function(n,o){var r=0,s=new t.list,p=e[o];p.forEach(function(e){var i=new t.node(e),n=e._getStartDateWithTimezoneAdaptation().getTime();if(s.getSize()===0){s.add(i);return}s.getIterator().forEach(function(t){var e=true,o=t.getData(),s=o._getStartDateWithTimezoneAdaptation().getTime(),p=o._getEndDateWithTimezoneAdaptation().getTime(),l=p-s;if(l<a){p=p+(a-l)}if(n>=s&&n<p){i.level++;r=Math.max(r,i.level)}if(t.next&&t.next.level===i.level){e=false}if(n>=p&&e){this.interrupt()}});s.insertAfterLevel(i.level,i)});n[o]={oAppointmentsList:i._calculateAppointmentsWidth(s),iMaxLevel:r};return n},{})};B.prototype._calculateAppointmentsWidth=function(e){e.getIterator().forEach(function(a){var i=a.getData(),n=a.level,o=a.level,r=i._getStartDateWithTimezoneAdaptation().getTime(),s=i._getEndDateWithTimezoneAdaptation().getTime(),p=s-r;if(p<H){s=s+(H-p)}new t.iterator(e).forEach(function(t){var e=t.getData(),i=t.level,p=e._getStartDateWithTimezoneAdaptation().getTime(),l=e._getEndDateWithTimezoneAdaptation().getTime(),g=l-p;if(g<H){l=l+(H-g)}if(o>=i){return}if(r>=p&&r<l||s>p&&s<l||r<=p&&s>=l){a.width=i-o;this.interrupt();return}if(n<i){n=i;a.width++}})});return e};B.prototype._calculateVisibleBlockers=function(t,e,a){var i=new u(e.getYear(),e.getMonth(),e.getDate()+a-1),n=this._isBlockerVisible(e,i);return t.filter(n).sort(this._sortAppointmentsByStartHourCallBack)};B.prototype._isBlockerVisible=function(t,e){return function(a){var i=u.fromLocalJSDate(a._getStartDateWithTimezoneAdaptation()),n=u.fromLocalJSDate(a._getEndDateWithTimezoneAdaptation());var o=i.isBefore(t)&&n.isAfter(e),r=c._isBetween(i,t,e,true),s=c._isBetween(n,t,e,true);return o||r||s}};B.prototype._calculateBlockersLevelsAndWidth=function(e){var a=0,i=new t.list;e.forEach(function(e){var n=new t.node(e),o=u.fromLocalJSDate(e._getStartDateWithTimezoneAdaptation()),r=u.fromLocalJSDate(e._getEndDateWithTimezoneAdaptation());n.width=c._daysBetween(r,o);if(i.getSize()===0){i.add(n);return}i.getIterator().forEach(function(t){var e=true,i=t.getData(),r=u.fromLocalJSDate(i._getStartDateWithTimezoneAdaptation()),s=u.fromLocalJSDate(i._getEndDateWithTimezoneAdaptation());if(o.isSameOrAfter(r)&&o.isSameOrBefore(s)){n.level++;a=Math.max(a,n.level)}if(t.next&&t.next.level===n.level){e=false}if(o.isSameOrAfter(s)&&e){this.interrupt()}});i.insertAfterLevel(n.level,n)},this);return{oBlockersList:i,iMaxlevel:a}};B.prototype._sortAppointmentsByStartHourCallBack=function(t,e){return t.getStartDate().getTime()-e.getStartDate().getTime()||e.getEndDate().getTime()-t.getEndDate().getTime()};B.prototype._getVisibleAppointments=function(){return this._oVisibleAppointments};B.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender};B.prototype._getVisibleBlockers=function(){return this._aVisibleBlockers};B.prototype._getBlockersToRender=function(){return this._oBlockersToRender};B.prototype._setColumns=function(t){this._iOldColumns=this._iColumns;this._iColumns=t;this.getAggregation("_columnHeaders").setDays(t);this.invalidate();return this};B.prototype._getColumns=function(){return this._iColumns};B.prototype._getRowHeight=function(){return this._isCompact()?T*this.getScaleFactor():S*this.getScaleFactor()};B.prototype._getBlockerRowHeight=function(){return this._isCompact()?M:R};B.prototype._isCompact=function(){var t=this.getDomRef();while(t&&t.classList){if(t.classList.contains("sapUiSizeCompact")){return true}t=t.parentNode}return false};B.prototype._getCoreLocaleId=function(){if(!this._sLocale){this._sLocale=y.getFormatSettings().getFormatLocale().toString()}return this._sLocale};B.prototype._getCoreLocaleData=function(){var t,e;if(!this._oLocaleData){t=this._getCoreLocaleId();e=new i(t);this._oLocaleData=a.getInstance(e)}return this._oLocaleData};B.prototype._hasAMPM=function(){var t=this._getCoreLocaleData();return t.getTimePattern("short").search("a")>=0};B.prototype._getHoursFormat=function(){var t=this._getCoreLocaleId();if(!this._oHoursFormat||this._oHoursFormat.oLocale.toString()!==t){var e=new i(t),a=this._getHoursPattern();this._oHoursFormat=o.getTimeInstance({pattern:a},e)}return this._oHoursFormat};B.prototype._getHoursPattern=function(){return this._hasAMPM()?"h":"H"};B.prototype._getAMPMFormat=function(){var t=this._getCoreLocaleId(),e=new i(t);if(!this._oAMPMFormat||this._oAMPMFormat.oLocale.toString()!==t){this._oAMPMFormat=o.getTimeInstance({pattern:"a"},e)}return this._oAMPMFormat};B.prototype._getColumnHeaders=function(){return this.getAggregation("_columnHeaders")};B.prototype._getAppointmentAnnouncementInfo=function(t){var e=this._oUnifiedRB.getText("CALENDAR_START_TIME"),a=this._oUnifiedRB.getText("CALENDAR_END_TIME"),i=this._oFormatStartEndInfoAria.format(t._getStartDateWithTimezoneAdaptation()),n=this._oFormatStartEndInfoAria.format(t._getEndDateWithTimezoneAdaptation()),o=e+": "+i+"; "+a+": "+n;return o+"; "+A.findLegendItemForItem(sap.ui.getCore().byId(this._sLegendId),t)};B.prototype.enhanceAccessibilityState=function(t,e){if(t.getId()===this._getColumnHeaders().getId()){e.labelledby=n.getStaticId("sap.m","PLANNINGCALENDAR_DAYS")}};B.prototype._getCellStartEndInfo=function(t,e){var a=this._oUnifiedRB.getText("CALENDAR_START_TIME"),i=this._oUnifiedRB.getText("CALENDAR_END_TIME"),n=!e;if(n){return a+": "+this._oFormatAriaFullDayCell.format(t)+"; "}return a+": "+this._oFormatStartEndInfoAria.format(t)+"; "+i+": "+this._oFormatStartEndInfoAria.format(e)};B.prototype.isAllDayAppointment=function(t,e){return c._isMidnight(t)&&c._isMidnight(e)};B.prototype._createBlockersDndPlaceholders=function(t,e){this.destroyAggregation("_blockersPlaceholders");for(var a=0;a<e;a++){var i=new p(t.getFullYear(),t.getMonth(),t.getDate()+a);var n=new W({date:i});this.addAggregation("_blockersPlaceholders",n,true)}};B.prototype._createAppointmentsDndPlaceholders=function(t,e){var a=this._getVisibleStartHour(),i=this._getVisibleEndHour();this._dndPlaceholdersMap={};this.destroyAggregation("_intervalPlaceholders");for(var n=0;n<e;n++){var o=new u(t.getFullYear(),t.getMonth(),t.getDate()+n);if(!this._dndPlaceholdersMap[o]){this._dndPlaceholdersMap[o]=[]}for(var r=a;r<=i;r++){var s=this._dndPlaceholdersMap[o],l=o.getYear(),g=o.getMonth(),d=o.getDate(),c=this.getScaleFactor()*2,h=60/c*60;for(var m=0;m<c;m++){s.push(this._createAppointmentsDndPlaceHolder(new p(l,g,d,r,0,h*m)))}}}};B.prototype._createAppointmentsDndPlaceHolder=function(t){var e=new W({date:t});this.addAggregation("_intervalPlaceholders",e,true);return e};B.prototype._getSpecialDates=function(){var t=this.getSpecialDates();for(var e=0;e<t.length;e++){var a=t[e].getSecondaryType()===g.CalendarDayType.NonWorking&&t[e].getType()!==g.CalendarDayType.NonWorking;if(a){var i=new h;i.setType(g.CalendarDayType.NonWorking);i.setStartDate(t[e].getStartDate());if(t[e].getEndDate()){i.setEndDate(t[e].getEndDate())}t.push(i)}}return t};function z(){var t=_("<span></span>").addClass("sapUiCalAppResizeGhost");t.appendTo(document.body);setTimeout(function(){t.remove()},0);return t.get(0)}var W=e.extend("sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",{metadata:{library:"sap.m",properties:{date:{type:"object",group:"Data"}}},renderer:{apiVersion:2,render:function(t,e){t.openStart("div",e).class("sapMSinglePCPlaceholder").openEnd().close("div")}}});function L(){var t=this.getDomRef(),e=this.$().find(".sapMSinglePCBlockersColumn").toArray();this._aGridCells=Array.prototype.concat(e);for(var a=0;a<=this._getVisibleEndHour();++a){e=this.$().find("div[data-sap-hour='"+a+"']").toArray();this._aGridCells=this._aGridCells.concat(e)}if(!this._oItemNavigation){this._oItemNavigation=new D;this.addDelegate(this._oItemNavigation)}this._oItemNavigation.setRootDomRef(t);this._oItemNavigation.setItemDomRefs(this._aGridCells);this._oItemNavigation.setCycling(false);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});this._oItemNavigation.setTableMode(true,true).setColumns(this._getColumns());this._oItemNavigation.setPageSize(this._aGridCells.length)}return B});