/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/p13n/modules/AdaptationProvider","sap/base/util/merge","sap/base/Log","sap/m/p13n/modification/FlexModificationHandler","sap/m/MessageStrip","sap/ui/core/library","sap/ui/core/Element","sap/m/p13n/modules/DefaultProviderRegistry","sap/m/p13n/modules/UIManager","sap/m/p13n/modules/StateHandlerRegistry","sap/m/p13n/modules/xConfigAPI"],function(t,e,r,n,i,o,a,s,l,c,f){"use strict";var u="Engine: This class is a singleton. Please use the getInstance() method instead.";var h=o.MessageType;var p=new WeakMap;var d;var g=t.extend("sap.m.p13n.Engine",{constructor:function(){t.call(this);if(d){throw Error(u)}this._aRegistry=[];this._aStateHandlers=[];this.defaultProviderRegistry=s.getInstance(this);this.uimanager=l.getInstance(this);this.stateHandlerRegistry=c.getInstance()}});g.prototype.register=function(t,e){if(!e.hasOwnProperty("controller")||Object.keys(e.controller).length<1){throw new Error("Please provide at least a configuration 'controller' containing a map of key-value pairs (key + Controller class) in order to register adaptation.")}if(!e.hasOwnProperty("helper")||!(e.helper.getProperties instanceof Function)){throw new Error("Please provide at least a configuration 'helper' containing a metadata helper instance implementing a #getProperties function.")}var r=this._getRegistryEntry(t);if(r){this.deregister(t)}r=this._createRegistryEntry(t,e);var n=Object.keys(e.controller);n.forEach(function(r){var n=e.controller[r];if(!this.getController(t,r)){if(this._aRegistry.indexOf(t.getId())<0){this._aRegistry.push(t.getId())}this.addController(n,r)}}.bind(this));this.getModificationHandler(t).initialize(t)};g.prototype.deregister=function(t){var e=this._getRegistryEntry(t);Object.keys(e.controller).forEach(function(t){var r=e.controller[t];r.destroy();delete e.controller[t]});p.delete(t);var r=this._aRegistry.indexOf(t.getId());this._aRegistry.splice(r,1)};g.prototype.show=function(t,e,r){return this.uimanager.show(t,e,r)};g.prototype.attachStateChange=function(t){return this.stateHandlerRegistry.attachChange(t)};g.prototype.detachStateChange=function(t){return this.stateHandlerRegistry.detachChange(t)};g.prototype.reset=function(t,e){e=e instanceof Array?e:[e];var r=[];e.forEach(function(e){r=r.concat(this.getController(t,e).getSelectorForReset())}.bind(this));var n={selectors:r,selector:t};var i=this._determineModification(t);return i.handler.reset(n,i.payload).then(function(){return this.initAdaptation(t,e).then(function(r){e.forEach(function(e){var n=this.getController(t,e);n.update(r)}.bind(this))}.bind(this))}.bind(this))};g.prototype.applyState=function(t,e,n){return this.retrieveState(t).then(function(i){var o=[],a=[],s={};if(t.validateState instanceof Function){s=t.validateState(this.externalizeKeys(t,e))}if(s.validation===h.Error){r.error(s.message)}var l=Object.keys(e);l.forEach(function(r){var i=this.getController(t,r);if(!i){return}var a=this.createChanges({control:t,key:r,state:i.sanityCheck(e[r]),suppressAppliance:true,applyAbsolute:n});o.push(a)}.bind(this));return Promise.all(o).then(function(e){var r={};e.forEach(function(t,e){if(t&&t.length>0){a=a.concat(t);var n=l[e];r[n]=t}});return this._processChanges(t,r)}.bind(this))}.bind(this))};g.prototype.retrieveState=function(t){return this.checkControlInitialized(t).then(function(){return g.getInstance().waitForChanges(t).then(function(){var r={};g.getInstance().getRegisteredControllers(t).forEach(function(e){r[e]=g.getInstance().getController(t,e).getCurrentState(true)});return e({},r)})})};g.prototype._setModificationHandler=function(t,e){if(!e.isA("sap.m.p13n.modification.ModificationHandler")){throw new Error("Only sap.m.p13n.modification.ModificationHandler derivations are allowed for modification")}var r=this._determineModification(t);r.handler=e;this._getRegistryEntry(t).modification=r};var y=function(t,e){var r=function(e){if(t._pModificationQueue===e){delete t._pModificationQueue}};t._pModificationQueue=t._pModificationQueue instanceof Promise?t._pModificationQueue.then(e):e();t._pModificationQueue.then(r.bind(null,t._pModificationQueue));return t._pModificationQueue};g.prototype.createChanges=function(t){var r=t.key;var n=t.state;var i=!!t.applyAbsolute;var o=!!t.suppressAppliance;var a=!!t.applySequentially;if(!r||!t.control||!n){throw new Error("To create changes via Engine, atleast a 1)Control 2)Key and 3)State needs to be provided.")}var s=g.getControlInstance(t.control);var l=function(){return this.initAdaptation(s,r).then(function(){var a=this.getController(s,r);var l=a.getChangeOperations();var c=this._getRegistryEntry(s);var f=a.getCurrentState();var u=e(f instanceof Array?[]:{},f);var h={existingState:t.stateBefore||u,applyAbsolute:i,changedState:n,control:a.getAdaptationControl(),changeOperations:l,deltaAttributes:["key"],propertyInfo:c.helper.getProperties().map(function(t){return{key:t.key}})};var p=a.getDelta(h);if(!o){var d={};d[r]=p;return this._processChanges(s,d)}return p||[]}.bind(this))}.bind(this);if(a){return y(s,l)}else{return l.apply(this)}};g.prototype.waitForChanges=function(t){var e=this._determineModification(t);return e.handler.waitForChanges({element:t},e.payload)};g.prototype.isModificationSupported=function(t){var e=this._determineModification(t);return e.handler.isModificationSupported({element:t},e.payload)};g.prototype.fireStateChange=function(t){return this.retrieveState(t).then(function(e){this.stateHandlerRegistry.fireChange(t,e)}.bind(this))};g.prototype._processChanges=function(t,e){var r=[];var n=Object.keys(e);n.forEach(function(t){r=r.concat(e[t])});if(r instanceof Array&&r.length>0){var i=this._determineModification(t);return i.handler.processChanges(r,i.payload).then(function(t){return t})}else{return Promise.resolve([])}};g.prototype.getRTASettingsActionHandler=function(t,e,r){var i;var o=this.hasForReference(t,"sap.m.p13n.PersistenceProvider");if(o.length>0&&!t.isA("sap.m.link.Panel")){return Promise.reject("Please do not use a PeristenceProvider in RTA.")}var a=this.getModificationHandler(t);var s=new n;var l=new Promise(function(t,e){i=t});s.processChanges=function(t){i(t);return Promise.resolve(t)};this._setModificationHandler(t,s);this.uimanager.show(t,r).then(function(t){var r=t._oPopup.getCustomHeader();if(r){r.getContentRight()[0].setVisible(false)}t._oPopup.addStyleClass(e.styleClass);if(e.fnAfterClose instanceof Function){t.attachAfterClose(e.fnAfterClose)}});l.then(function(){this._setModificationHandler(t,a);s.destroy()}.bind(this));return l};g.prototype.enhanceXConfig=function(t,e){var r=g.getControlInstance(t);var n=this._getRegistryEntry(t);return f.enhanceConfig(r,e).then(function(t){if(n){n.xConfig=t}})};g.prototype.readXConfig=function(t,e){var r=g.getControlInstance(t);return f.readConfig(r,e)||{}};g.prototype.externalizeKeys=function(t,e){var r={};Object.keys(e).forEach(function(n){var i=this.getController(g.getControlInstance(t),n);if(i){r[i.getStateKey()]=e[n]}}.bind(this));return r};g.prototype.internalizeKeys=function(t,e){var r=this.getRegisteredControllers(t),n={};r.forEach(function(r){var i=this.getController(t,r).getStateKey();if(e.hasOwnProperty(i)){n[r]=e[i]}}.bind(this));return n};g.prototype.diffState=function(t,r,n){var i=[],o={};r=e({},r);n=e({},n);this.getRegisteredControllers(t).forEach(function(e){i.push(this.createChanges({control:t,stateBefore:r[e],state:n[e],applyAbsolute:true,key:e,suppressAppliance:true}))}.bind(this));return Promise.all(i).then(function(e){this.getRegisteredControllers(t).forEach(function(i,a){var s=this.getController(t,i).changesToState(e[a],r[i],n[i]);o[i]=s}.bind(this));return o}.bind(this))};g.prototype.checkControlInitialized=function(t){var e=g.getControlInstance(t);return e.initialized instanceof Function?e.initialized():Promise.resolve()};g.prototype.checkPropertyHelperInitialized=function(t){var e=g.getControlInstance(t);return e.initPropertyHelper instanceof Function?e.initPropertyHelper():Promise.resolve()};g.prototype.initAdaptation=function(t,e){this.verifyController(t,e);var r=this._getRegistryEntry(t);var n=g.getControlInstance(t);if(r.helper){return Promise.resolve(r.helper)}return this.checkPropertyHelperInitialized(n).then(function(t){r.helper=t;return t},function(t){throw new Error(t)})};g.prototype.addController=function(t,e,r){var n=this._getRegistryEntry(t.getAdaptationControl(),r);n.controller[e]=t};g.prototype.getController=function(t,e){var r=this._getRegistryEntry(t);if(r&&r.controller.hasOwnProperty(e)){return r.controller[e]}};g.prototype.verifyController=function(t,e){var r=e instanceof Array?e:[e];r.forEach(function(e){if(!this.getController(t,e)){var r=g.getControlInstance(t);throw new Error("No controller registered yet for "+r.getId()+" and key: "+e)}}.bind(this))};g.prototype.getUISettings=function(t,e){var r=Array.isArray(e)?e:[e];this.verifyController(t,r);var n=this._getRegistryEntry(t).helper;var i={},o=[];r.forEach(function(e){var r=this.getController(t,e);var i=r.initAdaptationUI(n);if(i instanceof Promise){o.push(i)}}.bind(this));return Promise.all(o).then(function(t){t.forEach(function(t,e){var n=r[e];i[n]={panel:t}});return i})};g.prototype.isRegisteredForModification=function(t){var e=this._getRegistryEntry(t);return e&&!!e.modification};g.prototype.getRegisteredControllers=function(t){var e=this._getRegistryEntry(t);return Object.keys(e.controller)};g.prototype._getRegistryEntry=function(t){var e=g.getControlInstance(t);return p.get(e)};g.prototype.getModificationHandler=function(t){var e=this._determineModification(t);return e.handler};g.prototype._createRegistryEntry=function(t,e){var r=g.getControlInstance(t);if(!p.has(r)){p.set(r,{modification:e&&e.modification?{handler:e.modification,payload:{mode:"Auto",hasVM:true,hasPP:false}}:null,controller:{},activeP13n:null,helper:e&&e.helper?e.helper:null,xConfig:null})}return p.get(r)};g.prototype._determineModification=function(t){var e=this._getRegistryEntry(t);if(e&&e.modification){return e.modification}var r=this.hasForReference(t,"sap.m.p13n.PersistenceProvider");var i=this.hasForReference(t,"sap.ui.fl.variants.VariantManagement");var o=r.length?r:undefined;var a=o?o[0].getMode():"Standard";var s={undefined:n,Global:n,Transient:n,Standard:n,Auto:n};var l=s[a];if(!l){throw new Error("Please provide a valid ModificationHandler! - valid Modification handlers are:"+Object.keys(s))}var c={handler:l.getInstance(),payload:{hasVM:i&&i.length>0,hasPP:r&&r.length>0,mode:a}};if(e&&!e.modification){e.modification=c}return c};g.prototype.hasForReference=function(t,e){var r=t&&t.getId?t.getId():t;var n=a.registry.filter(function(t){if(!t.isA(e)){return false}var n=t.getFor instanceof Function?t.getFor():[];for(var i=0;i<n.length;i++){if(n[i]===r||this.hasControlAncestorWithId(r,n[i])){return true}}return false});return n};g.prototype.hasControlAncestorWithId=function(t,e){var r;if(t===e){return true}r=sap.ui.getCore().byId(t);while(r){if(r.getId()===e){return true}if(typeof r.getParent==="function"){r=r.getParent()}else{return false}}return false};g.getControlInstance=function(t){return typeof t=="string"?sap.ui.getCore().byId(t):t};g.prototype.hasActiveP13n=function(t){return!!this._getRegistryEntry(t).activeP13n};g.prototype.setActiveP13n=function(t,e){this._getRegistryEntry(t).activeP13n=e};g.prototype.validateP13n=function(t,e,n){var o=this.getController(t,e);var a=g.getControlInstance(t);var s=this._getRegistryEntry(t).controller;var l={};Object.keys(s).forEach(function(t){l[t]=s[t].getCurrentState()});if(o&&o.model2State instanceof Function){l[e]=o.model2State();var c={validation:h.None};if(a.validateState instanceof Function){c=a.validateState(this.externalizeKeys(a,l),e)}var f;if(c.validation!==h.None){f=new i({type:c.validation,text:c.message})}if(n.setMessageStrip instanceof Function){n.setMessageStrip(f)}else{r.warning("message strip could not be provided - the adaptation UI needs to implement 'setMessageStrip'")}}};g.prototype.handleP13n=function(t,e){var r=[];e.forEach(function(e){var n=this.getController(t,e);var i=this.createChanges({control:t,key:e,state:n.getP13nData(),suppressAppliance:true,applyAbsolute:true}).then(function(t){return n.getBeforeApply().then(function(e){var r=e?e.concat(t):t;return r})});r.push(i)}.bind(this));return Promise.all(r).then(function(r){var n=[];var i={};r.forEach(function(t,r){n=n.concat(t);var o=e[r];i[o]=t});if(n.length>0){g.getInstance()._processChanges(t,i)}})};g.getInstance=function(){if(!d){d=new g}return d};g.prototype._getRegistry=function(){var t={stateHandlerRegistry:this.stateHandlerRegistry,defaultProviderRegistry:this.defaultProviderRegistry,controlRegistry:{}};this._aRegistry.forEach(function(e){var r=sap.ui.getCore().byId(e);t.controlRegistry[e]=p.get(r)});return t};g.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);d=null;this._aRegistry=null;p.delete(this);this.defaultProviderRegistry.destroy();this.defaultProviderRegistry=null;this.stateHandlerRegistry.destroy();this.stateHandlerRegistry=null;this.uimanager.destroy();this.uimanager=null};return g.getInstance()});
//# sourceMappingURL=Engine.js.map