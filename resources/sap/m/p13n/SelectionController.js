/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/array/diff","sap/ui/base/Object","sap/base/util/merge","sap/base/util/deepEqual","sap/m/p13n/SelectionPanel","sap/m/p13n/modules/xConfigAPI","sap/ui/core/Configuration"],function(e,t,n,r,i,o,a){"use strict";var s=t.extend("sap.m.p13n.SelectionController",{constructor:function(e){t.call(this);this._oAdaptationControl=e.control;if(!this._oAdaptationControl){throw new Error("Always provide atleast a 'control' configuration when creating a new p13n controller!")}this._sTargetAggregation=e.targetAggregation;this._fSelector=e.selector;this._oP13nData=null;this._bLiveMode=false;this._bResetEnabled=false;this._bReorderingEnabled=e.hasOwnProperty("enableReorder")?e.enableReorder:true}});s.prototype.getAdaptationControl=function(){return this._oAdaptationControl};s.prototype.getTargetAggregation=function(){return this._sTargetAggregation};s.prototype.getChangeOperations=function(){return{add:"addItem",remove:"removeItem",move:"moveItem"}};s.prototype.getSelectorForReset=function(){return this._oAdaptationControl};s.prototype.sanityCheck=function(e){return e};s.prototype.initAdaptationUI=function(e){var t=this.mixInfoAndState(e);this._oPanel=this.createUI(t);return Promise.resolve(this._oPanel)};s.prototype.createUI=function(e){var t=new i({showHeader:true,enableCount:true});t.setEnableReorder(this._bReorderingEnabled);return t.setP13nData(e.items)};s.prototype.getCurrentState=function(){var e=[],t=this.getAdaptationControl().getAggregation(this.getTargetAggregation())||[];t.forEach(function(t,n){var r=this._fSelector?this._fSelector({key:t.getId()}):t.getVisible();if(r){e.push({key:t.getId()})}}.bind(this));var n=o.readConfig(this.getAdaptationControl())||{};var r=n.hasOwnProperty("aggregations")?n.aggregations[this._sTargetAggregation]:{};for(var i in r){var a=e.map(function(e){return e.key});var s=a.indexOf(i);var p=r[i].position;var l=r[i].visible!==false;var c=p!==undefined;if(l&&s===-1){e.push({key:i})}if(l&&c&&e.length>0){var g=e.splice(s,1)[0];e.splice(p,0,g);s=p}if(r[i].visible===false&&s>-1){e.splice(s,1)}}return e};s.prototype.getStateKey=function(){return"items"};s.prototype.getDelta=function(e){var t=this._getPresenceAttribute(e.externalAppliance);var n;var i=function(e){return e.hasOwnProperty(t)&&e[t]===false?false:true};n=e.applyAbsolute?e.changedState.filter(i):this._getFilledArray(e.existingState,e.changedState,t).filter(i);e.changedState=n;if(r(e.existingState,n)){return[]}else{return this.getArrayDeltaChanges(e)}};s.prototype.getArrayDeltaChanges=function(t){var n=t.existingState;var r=t.changedState;var i=t.control;var o=t.changeOperations.add;var a=t.changeOperations.remove;var s=t.changeOperations.move;var p=t.generator;var l=t.deltaAttributes||[];var c=function(e){var t="";l.forEach(function(n){t=t+e[n]});return t};var g=e(n,r,c);var u=function(e,t){return t.filter(function(t){return t&&t.key===e.key})[0]};var f=[];var h=n.slice(0);g.forEach(function(e){if(e.type==="delete"&&h[e.index]===undefined){h.splice(e.index,1);return}var t,n,c;if(e.type==="insert"){n=u(r[e.index],h);if(n){n.index=h.indexOf(n);h.splice(n.index,1,undefined);f=f.concat(this._createAddRemoveChange(i,a,this._getChangeContent(n,l),p))}}t=e.type==="delete"?h[e.index]:r[e.index];t.index=e.index;if(e.type==="delete"){h.splice(t.index,1)}else{h.splice(t.index,0,t)}if(s){c=f.length;if(c){n=f[c-1];n=n?n.changeSpecificData.content:undefined}if(n&&n.key===t.key&&e.index!=n.index){f.pop();f=f.concat(this._createMoveChange(n.id,n.key,e.index,s,i,s!=="moveSort",p));return}}f=f.concat(this._createAddRemoveChange(i,e.type==="delete"?a:o,this._getChangeContent(t,l),p))}.bind(this));return f};s.prototype._getChangeContent=function(e,t){var n={};if(e.index>=0){n.index=e.index}t.forEach(function(t){if(e.hasOwnProperty(t)){n[t]=e[t]}});return n};s.prototype._createAddRemoveChange=function(e,t,n){var r={selectorElement:e,changeSpecificData:{changeType:t,content:{key:n.key,targetAggregation:this.getTargetAggregation(),index:n.index,value:t===this.getChangeOperations()["add"]}}};return r};s.prototype._createMoveChange=function(e,t,n,r,i,o){var a={selectorElement:i,changeSpecificData:{changeType:r,content:{key:t,targetAggregation:this.getTargetAggregation(),index:n}}};return a};s.prototype._getPresenceAttribute=function(e){return"visible"};s.prototype.getBeforeApply=function(){return Promise.resolve()};s.prototype.mixInfoAndState=function(e){var t=this.getCurrentState();var n=this.arrayToMap(t);var r=this.prepareAdaptationData(e,function(e,t){var r=n[t.key];e.visible=this._fSelector?this._fSelector(t):!!r;e.position=r?r.position:-1;return!(t.visible===false)}.bind(this));this.sortP13nData({visible:"visible",position:"position"},r.items);r.items.forEach(function(e){delete e.position});return r};s.prototype.getP13nData=function(){return this._oPanel?this._oPanel.getP13nData():this._oAdaptationModel.getProperty("/items")};s.prototype.model2State=false;s.prototype.update=function(e){if(this._oPanel){var t=this.mixInfoAndState(e);this._oPanel.setP13nData(t.items)}else if(this._oAdaptationModel){var n=this.mixInfoAndState(e);this._oAdaptationModel.setProperty("/items",n.items);this._oAdaptationModel.setProperty("/itemsGrouped",n.itemsGrouped)}};s.prototype._getFilledArray=function(e,t,r){var i=n([],e);var o=n([],t);var a=this.arrayToMap(e);o.forEach(function(e){var t=a[e.key];if(!e.hasOwnProperty(r)||e[r]){var n=e.position;if(t){n=n>-1?n:t.position;var o=t.position;i.splice(n,0,i.splice(o,1)[0])}else{n=n>-1?n:i.length;i.splice(n,0,e)}i[n]=e}else if(t){i[t.position][r]=false}});return i};s.prototype.changesToState=function(e){var t=[];e.forEach(function(e){var r=n({},e.changeSpecificData.content);var i=r.index;delete r.index;if(e.changeSpecificData.changeType===this.getChangeOperations()["move"]){r.position=i}if(e.changeSpecificData.changeType===this.getChangeOperations()["remove"]){r[this._getPresenceAttribute()]=false}t.push(r)}.bind(this));return t};s.prototype.prepareAdaptationData=function(e,t,n){var r=[];var i=n?{}:null;var o=t instanceof Function;e.getProperties().forEach(function(e){var n={};if(o){var a=t(n,e);if(!a){return}}n.key=e.key;n.name=e.key;n.label=e.label||e.key;n.tooltip=e.tooltip;if(i){n.group=e.group?e.group:"BASIC";n.groupLabel=e.groupLabel;i[n.group]=i[n.group]?i[n.group]:[];i[n.group].push(n)}r.push(n)});var a={items:r};if(i){a.itemsGrouped=this._buildGroupStructure(i)}return a};s.prototype.sortP13nData=function(e,t){var n=e;var r=n.position;var i=n.visible;var o=a.getLocale().toString();var s=window.Intl.Collator(o,{});t.sort(function(e,t){if(e[i]&&t[i]){return(e[r]||0)-(t[r]||0)}else if(e[i]){return-1}else if(t[i]){return 1}else if(!e[i]&&!t[i]){return s.compare(e.label,t.label)}})};s.prototype.arrayToMap=function(e){return e.reduce(function(e,t,n){e[t.key]=t;e[t.key].position=n;return e},{})};s.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);this._oAdaptationControl=null;this._bLiveMode=null;this._oPanel=null;this._bResetEnabled=null;this._oAdaptationModel=null};return s});