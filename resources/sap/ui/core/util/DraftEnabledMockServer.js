/*
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject"],function(t,a){"use strict";return{_oDraftMetadata:{},_oConstants:{COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT:"com.sap.vocabularies.Common.v1.DraftRoot",COM_SAP_VOCABULARIES_COMMON_V1_DRAFTNODE:"com.sap.vocabularies.Common.v1.DraftNode",COM_SAP_VOCABULARIES_COMMON_V1_SEMANTICKEY:"com.sap.vocabularies.Common.v1.SemanticKey",EMPTY_GUID:"00000000-0000-0000-0000-000000000000",SIBLINGENTITY_NAVIGATION:"SiblingEntity",DRAFT_ADMINISTRATIVE_DATA:"DraftAdministrativeData",DRAFT_ADMINISTRATIVE_DATA_UUID:"DraftAdministrativeDataUUID",ACTIVATION_ACTION:"ActivationAction",EDIT_ACTION:"EditAction",VALIDATE_ACTION:"ValidationFunction",PREPARE_ACTION:"PreparationAction"},handleDraft:function(a,e){var r=sap.ui.require("sap/ui/core/util/MockServer");var o=r._syncAjax;var i=function(t){var a=t.getParameter("oEntity");a.IsActiveEntity=false;a.HasActiveEntity=false;a.HasDraftEntity=false};var s=function(t){var a=t.getParameter("oXhr");var e=o({url:a.url,dataType:"json"}).data.d;for(var r=0;r<this._oDraftMetadata.draftNodes.length;r++){for(var i in this._mEntitySets[this._oDraftMetadata.draftRootName].navprops){if(this._mEntitySets[this._oDraftMetadata.draftRootName].navprops[i].to.entitySet===this._oDraftMetadata.draftNodes[r]){var s=o({url:e[i].__deferred.uri,dataType:"json"});if(s.data&&s.data.d&&s.data.d.results){var n;for(var f=0;f<s.data.d.results.length;f++){n=s.data.d.results[f];o({url:n.__metadata.uri,type:"DELETE"})}}}}}};if(a&&a.EntityContainer){var n=a.EntityContainer[Object.keys(a.EntityContainer)[0]];for(var f in n){var d=n[f];if(d[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT]){this._oDraftMetadata.draftRootName=f;this._oDraftMetadata.annotations=a;this._oDraftMetadata.mockServerRootUri=e.getRootUri();if(d[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.ACTIVATION_ACTION]){this._oDraftMetadata.draftRootActivationName=d[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.ACTIVATION_ACTION].String}if(this._oDraftMetadata.draftRootActivationName){this._oDraftMetadata.draftRootActivationName=this._oDraftMetadata.draftRootActivationName.substring(this._oDraftMetadata.draftRootActivationName.lastIndexOf("/")+1)}this._oDraftMetadata.draftRootEditName=d[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.EDIT_ACTION];this._oDraftMetadata.draftRootEditName=this._oDraftMetadata.draftRootEditName?this._oDraftMetadata.draftRootEditName.String:undefined;if(this._oDraftMetadata.draftRootEditName){this._oDraftMetadata.draftRootEditName=this._oDraftMetadata.draftRootEditName.substring(this._oDraftMetadata.draftRootEditName.lastIndexOf("/")+1)}this._oDraftMetadata.draftRootValidationName=d[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.VALIDATE_ACTION];this._oDraftMetadata.draftRootValidationName=this._oDraftMetadata.draftRootValidationName?this._oDraftMetadata.draftRootValidationName.String:undefined;if(this._oDraftMetadata.draftRootValidationName){this._oDraftMetadata.draftRootValidationName=this._oDraftMetadata.draftRootValidationName.substring(this._oDraftMetadata.draftRootValidationName.lastIndexOf("/")+1)}this._oDraftMetadata.draftRootPreparationtionName=d[this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTROOT][this._oConstants.PREPARE_ACTION];this._oDraftMetadata.draftRootPreparationtionName=this._oDraftMetadata.draftRootPreparationtionName?this._oDraftMetadata.draftRootPreparationtionName.String:undefined;if(this._oDraftMetadata.draftRootPreparationtionName){this._oDraftMetadata.draftRootPreparationtionName=this._oDraftMetadata.draftRootPreparationtionName.substring(this._oDraftMetadata.draftRootPreparationtionName.lastIndexOf("/")+1)}t.extend(e,this);e.attachAfter(r.HTTPMETHOD.POST,i,this._oDraftMetadata.draftRootName);e.attachBefore(r.HTTPMETHOD.DELETE,s,this._oDraftMetadata.draftRootName);e.attachAfter(r.HTTPMETHOD.GET,this._fnDraftAdministrativeData,this._oDraftMetadata.draftRootName)}}}},_calcSemanticKeys:function(t,a){var e=[];for(var r in this._oDraftMetadata.annotations){if(r.lastIndexOf(a[t].type)>-1){e=this._oDraftMetadata.annotations[r][this._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_SEMANTICKEY]||[];break}}var o=[];var i;for(var s=0;s<e.length;s++){i=e[s];for(var n in i){o.push(i[n])}}return o},_prepareDraftMetadata:function(t){var a=this;var e=sap.ui.require("sap/ui/core/util/MockServer");this._oDraftMetadata.draftNodes=[];this._oDraftMetadata.draftRootKey=t[this._oDraftMetadata.draftRootName].keys.filter(function(e){return a._calcSemanticKeys(a._oDraftMetadata.draftRootName,t).indexOf(e)<0})[0];var r=a._oDraftMetadata.annotations;var o=r.EntityContainer[Object.keys(r.EntityContainer)[0]];for(var i in o){var s=o[i];if(s[a._oConstants.COM_SAP_VOCABULARIES_COMMON_V1_DRAFTNODE]){this._oDraftMetadata.draftNodes.push(i)}}for(var n=0;n<this._oDraftMetadata.draftNodes.length;n++){this.attachAfter(e.HTTPMETHOD.GET,this._fnDraftAdministrativeData,this._oDraftMetadata.draftNodes[n])}},_fnDraftAdministrativeData:function(t){var e={};var r=t.getParameter("oFilteredData");if(!r){e=t.getParameter("oEntry");if(e.IsActiveEntity&&!e.HasDraftEntity){e[this._oConstants.DRAFT_ADMINISTRATIVE_DATA]=null}}else{if(r.results){r=r.results}else{if(a(r)){r=null;return}}for(var o=0;o<r.length;o++){e=r[o];if(e.IsActiveEntity&&!e.HasDraftEntity){e[this._oConstants.DRAFT_ADMINISTRATIVE_DATA]=null}}}},_handleDraftArtifacts:function(a){var e=this;var r=this._oMockdata;var o=r[this._oDraftMetadata.draftRootName];var i=function(t,a){return t.filter(function(t){return a.indexOf(t)<0})[0]};if(o.length===100){for(var s=0;s<o.length;s++){var n=o[s];if(s<25){n.IsActiveEntity=true;n.HasActiveEntity=false;n.HasDraftEntity=false;n[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;if(n[this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]){n[this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]=null}var f=[];var d=[];for(var _=0;_<this._oDraftMetadata.draftNodes.length;_++){d=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[_],a);f=r[this._oDraftMetadata.draftNodes[_]];var D=a[this._oDraftMetadata.draftRootName];for(var h in D.navprops){var v=D.navprops[h];if(v.to.entitySet===this._oDraftMetadata.draftNodes[_]){var u=v.from.propRef.length;for(var M=0;M<u;M++){f[s][v.to.propRef[M]]=n[v.from.propRef[M]]}}}f[s].IsActiveEntity=true;f[s].HasActiveEntity=false;f[s].HasDraftEntity=false;f[s][this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;if(f[s][this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]){f[s][this._oConstants.DRAFT_ADMINISTRATIVE_DATA_UUID]=null}var A=i(a[this._oDraftMetadata.draftNodes[_]].keys,d);f[s][A]=this._oConstants.EMPTY_GUID}}else if(s<50){n.IsActiveEntity=false;n.HasActiveEntity=false;n.HasDraftEntity=false;f=[];d=[];for(var _=0;_<this._oDraftMetadata.draftNodes.length;_++){d=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[_],a);f=r[this._oDraftMetadata.draftNodes[_]];var D=a[this._oDraftMetadata.draftRootName];for(var h in D.navprops){var v=D.navprops[h];if(v.to.entitySet===this._oDraftMetadata.draftNodes[_]){var u=v.from.propRef.length;for(var M=0;M<u;M++){f[s][v.to.propRef[M]]=n[v.from.propRef[M]]}}}f[s].IsActiveEntity=false;f[s].HasActiveEntity=false;f[s].HasDraftEntity=false;A=i(a[this._oDraftMetadata.draftNodes[_]].keys,d)}}else if(s<75){var p=t.extend(true,{},n);n.IsActiveEntity=true;n.HasActiveEntity=false;n.HasDraftEntity=true;n[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;f=[];d=[];for(var _=0;_<this._oDraftMetadata.draftNodes.length;_++){d=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[_],a);f=r[this._oDraftMetadata.draftNodes[_]];var D=a[this._oDraftMetadata.draftRootName];for(var h in D.navprops){var v=D.navprops[h];if(v.to.entitySet===this._oDraftMetadata.draftNodes[_]){var u=v.from.propRef.length;for(var M=0;M<u;M++){f[s][v.to.propRef[M]]=n[v.from.propRef[M]]}}}f[s].IsActiveEntity=true;f[s].HasActiveEntity=false;f[s].HasDraftEntity=true;A=i(a[this._oDraftMetadata.draftNodes[_]].keys,d);f[s][A]=this._oConstants.EMPTY_GUID}p.IsActiveEntity=false;p.HasActiveEntity=true;p.HasDraftEntity=false;o[s+25]=p}}}var E=this._getRootUri();t.each(a,function(a,o){t.each(r[a],function(r,i){i.__metadata=i.__metadata||{};i.__metadata.uri=E+a+"("+e._createKeysString(o,i)+")";i.__metadata.type=o.schema+"."+o.type;t.each(o.navprops,function(t){i[t]={__deferred:{uri:E+a+"("+e._createKeysString(o,i)+")/"+t}}})})})},_activate:function(t){var a=sap.ui.require("sap/ui/core/util/MockServer");var e=a._syncAjax;var r;var o=function(t,a){return t.filter(function(t){return a.indexOf(t)<0})[0]};for(var i=0;i<this._oDraftMetadata.draftNodes.length;i++){for(var s in this._mEntitySets[this._oDraftMetadata.draftRootName].navprops){if(this._mEntitySets[this._oDraftMetadata.draftRootName].navprops[s].to.entitySet===this._oDraftMetadata.draftNodes[i]){r=e({url:t[s].__deferred.uri,dataType:"json"});if(r.success&&r.data&&r.data.d&&r.data.d.results){var n;for(var f=0;f<r.data.d.results.length;f++){n=r.data.d.results[f];n.IsActiveEntity=true;n.HasActiveEntity=false;n.HasDraftEntity=false;n[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;var d=this._calcSemanticKeys(this._oDraftMetadata.draftNodes[i],this._mEntitySets);var _=o(this._mEntitySets[this._oDraftMetadata.draftNodes[i]].keys,d);n[_]=this._oConstants.EMPTY_GUID;e({url:n.__metadata.uri,type:"PATCH",data:JSON.stringify(n)})}}}}}t.IsActiveEntity=true;t.HasActiveEntity=false;t.HasDraftEntity=false;t[this._oDraftMetadata.draftRootKey]=this._oConstants.EMPTY_GUID;e({url:t.__metadata.uri,type:"PATCH",data:JSON.stringify(t)});return t},setRequests:function(e){var r=this;var o=sap.ui.require("sap/ui/core/util/MockServer");var i=o._syncAjax;e.push({method:"POST",path:new RegExp(r._oDraftMetadata.draftRootActivationName),response:function(t){var a=JSON.parse(t.requestBody);var e=[];for(var o in a){e.push(o+" eq "+a[o])}var s=i({url:r._oDraftMetadata.mockServerRootUri+r._oDraftMetadata.draftRootName+"?$filter="+e.join(" and "),dataType:"json"});if(!s.success||!s.data.d.results[0]){t.respond(404)}var n=s.data.d.results[0];if(n.IsActiveEntity){t.respond(400)}if(n.HasActiveEntity){var f=n.SiblingEntity.__deferred.uri;s=i({url:f,dataType:"json"});if(s.success&&s.data&&s.data.d.__metadata){var d=s.data.d;s=i({url:d.__metadata.uri,type:"DELETE"})}}n=r._activate(n);t.respondJSON(200,{},JSON.stringify({d:n}));return true}});if(r._oDraftMetadata.draftRootEditName){e.push({method:"POST",path:new RegExp(r._oDraftMetadata.draftRootEditName+"(\\?(.*))?"),response:function(e,o){var s=[];var n=JSON.parse(e.requestBody);if(n&&!a(n)){for(var f in n){s.push(f+" eq "+n[f])}}else{var d=decodeURIComponent(o).replace("?","&").split("&");for(var _ in d){var D=d[_];var h=new RegExp("(.*)=(.*)");var v;if(D){v=h.exec(D);s.push(v[1]+" eq "+v[2])}}}var u=i({url:r._oDraftMetadata.mockServerRootUri+r._oDraftMetadata.draftRootName+"?$filter="+s.join(" and "),dataType:"json"});if(!u.success||!u.data.d.results[0]){e.respond(404)}var M=u.data.d.results[0];if(!M.IsActiveEntity||M.HasDraftEntity){e.respond(400)}var A=t.extend(true,{},M);A.IsActiveEntity=false;A.HasActiveEntity=true;A.HasDraftEntity=false;A[r._oDraftMetadata.draftRootKey]=r._generatePropertyValue(r._oDraftMetadata.draftRootKey,"Guid");var p=r._getRootUri();var E=r._mEntitySets[r._oDraftMetadata.draftRootName];A.__metadata=A.__metadata||{};A.__metadata.uri=p+r._oDraftMetadata.draftRootName+"("+r._createKeysString(E,A)+")";A.__metadata.type=E.schema+"."+E.type;t.each(E.navprops,function(t){A[t]={__deferred:{uri:p+r._oDraftMetadata.draftRootName+"("+r._createKeysString(E,A)+")/"+t}}});r._oMockdata[r._oDraftMetadata.draftRootName].push(A);u=i({url:M.__metadata.uri,type:"PATCH",data:JSON.stringify({HasDraftEntity:true})});e.respondJSON(200,{},JSON.stringify({d:A}));return true}})}if(r._oDraftMetadata.draftRootValidationName){e.push({method:"GET",path:new RegExp(r._oDraftMetadata.draftRootValidationName+"(\\?(.*))?"),response:function(t,a){var e=r._oDraftMetadata.draftRootValidationName;r.fireEvent(o.HTTPMETHOD.GET+e+":before",{oXhr:t,sUrlParams:a});r.fireEvent(o.HTTPMETHOD.GET+":before",{oXhr:t,sUrlParams:a});var i={d:{}};i.d[e]={__metadata:{type:"ValidationResult"},IsValid:true};r.fireEvent(o.HTTPMETHOD.GET+e+":after",{oXhr:t,oResult:i});r.fireEvent(o.HTTPMETHOD.GET+":after",{oXhr:t,oResult:i});t.respondJSON(200,{},JSON.stringify(i));return true}})}if(r._oDraftMetadata.draftRootPreparationtionName){e.push({method:"POST",path:new RegExp(r._oDraftMetadata.draftRootPreparationtionName),response:function(t){r.fireEvent(o.HTTPMETHOD.POST+r._oDraftMetadata.draftRootPreparationtionName+":before",{oXhr:t});r.fireEvent(o.HTTPMETHOD.POST+":before",{oXhr:t});var a=JSON.parse(t.requestBody);var e=[];for(var s in a){e.push(s+" eq "+a[s])}var n=i({url:r._oDraftMetadata.mockServerRootUri+r._oDraftMetadata.draftRootName+"?$filter="+e.join(" and "),dataType:"json"});if(!n.success||!n.data.d.results[0]){t.respond(404)}var f=n.data.d.results[0];r.fireEvent(o.HTTPMETHOD.POST+r._oDraftMetadata.draftRootPreparationtionName+":after",{oXhr:t,oEntry:f});r.fireEvent(o.HTTPMETHOD.POST+":after",{oXhr:t,oEntry:f});t.respondJSON(200,{},JSON.stringify({d:f}));return true}})}o.prototype.setRequests.apply(this,[e])},_generateMockdata:function(t,a){var e=sap.ui.require("sap/ui/core/util/MockServer");e.prototype._generateMockdata.apply(this,[t,a]);this._handleDraftArtifacts(t)},_loadMockdata:function(t,a){var e=sap.ui.require("sap/ui/core/util/MockServer");e.prototype._loadMockdata.apply(this,[t,a]);this._handleDraftArtifacts(t)},_resolveNavigation:function(t,a,e,r){var o=sap.ui.require("sap/ui/core/util/MockServer");var i=o.prototype._resolveNavigation.apply(this,[t,a,e,r]);if(e===this._oConstants.SIBLINGENTITY_NAVIGATION){if(r&&r.IsActiveEntity){i.splice(0,1)}else{i.length>1?i.splice(1,1):i.splice(0,1)}}else if(e===this._oConstants.DRAFT_ADMINISTRATIVE_DATA){if(r){if(r.IsActiveEntity&&!r.HasDraftEntity){i[0]=null}}else{i[0]=null}}return i},_findEntitySets:function(t){var a=sap.ui.require("sap/ui/core/util/MockServer");var e=a.prototype._findEntitySets.apply(this,[t]);this._prepareDraftMetadata(e);return e},getEntitySetData:function(t){var a=sap.ui.require("sap/ui/core/util/MockServer");var e=a.prototype.getEntitySetData.apply(this,[t]);var r=function(){return e};if(t===this._oDraftMetadata.draftRootName){this._fnDraftAdministrativeData({getParameter:r});return e}for(var o=0;o<this._oDraftMetadata.draftNodes.length;o++){if(t===this._oDraftMetadata.draftNodes[o]){this._fnDraftAdministrativeData({getParameter:r});return e}}return e}}},true);