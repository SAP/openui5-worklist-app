/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log","sap/base/util/fetch","sap/base/util/Version","sap/ui/thirdparty/jquery"],function(e,t,r,a,n){"use strict";var o=e.extend("sap.ui.core.util.LibraryInfo",{constructor:function(){e.apply(this);this._oLibInfos={}},destroy:function(){e.prototype.destroy.apply(this,arguments);this._oLibInfos={}},getInterface:function(){return this}});o.prototype._loadLibraryMetadata=function(e,a){e=e.replace(/\//g,".");if(this._oLibInfos[e]){setTimeout(a.bind(window,this._oLibInfos[e]),0);return}var n=this,o,i,s=/themelib_(.*)/i.exec(e),l;if(!s){i=".library";o=sap.ui.require.toUrl(e.replace(/\./g,"/"))+"/"}else{i=".theme";o=sap.ui.require.toUrl("sap/ui/core/themes/"+s[1]+"/")}l=typeof n.getResourceUrl==="function"?n.getResourceUrl(o):o;function f(r){t.error("failed to load library details from '"+o+i+": "+r.message+", "+r);n._oLibInfos[e]={name:e,data:null,url:o};a(n._oLibInfos[e])}r(l+i,{headers:{Accept:r.ContentTypes.XML}}).then(function(t){if(t.ok){return t.text().then(function(t){var r=new DOMParser;var i=r.parseFromString(t,"text/xml");n._oLibInfos[e]={name:e,data:i,url:o};a(n._oLibInfos[e])})}else{throw new Error(t.statusText||t.status)}}).catch(f)};o.prototype._getLibraryInfo=function(e,t){this._loadLibraryMetadata(e,function(e){var r={libs:[],library:e.name,libraryUrl:e.url};if(e.data){var a=n(e.data);r.vendor=a.find("vendor").text();r.copyright=a.find("copyright").text();r.version=a.find("version").text();r.documentation=a.find("documentation").text();r.releasenotes=a.find("releasenotes").attr("url");r.componentInfo=o.prototype._getLibraryComponentInfo(a)}t(r)})};o.prototype._getThirdPartyInfo=function(e,t){this._loadLibraryMetadata(e,function(e){var r={libs:[],library:e.name,libraryUrl:e.url};if(e.data){var a=n(e.data).find("appData").find("thirdparty").children();a.each(function(t,a){if(a.nodeName==="lib"){var o=n(a);var i=o.children("license");r.libs.push({displayName:o.attr("displayName"),homepage:o.attr("homepage"),license:{url:i.attr("url"),type:i.attr("type"),file:e.url+i.attr("file")}})}})}t(r)})};o.prototype._getDocuIndex=function(e,a){var o=this;this._loadLibraryMetadata(e,function(e){var i=e.name,s=e.url,l={docu:{},library:i,libraryUrl:s};if(!e.data){a(l);return}var f=n(e.data).find("appData").find("documentation");var u=f.attr("indexUrl");if(!u){a(l);return}if(f.attr("resolve")=="lib"){u=e.url+u}if(typeof o.getResourceUrl==="function"){u=o.getResourceUrl(u)}r(u,{headers:{Accept:r.ContentTypes.JSON}}).then(function(e){if(e.ok){e.json().then(function(e){e.library=i;e.libraryUrl=s;a(e)})}else{throw new Error(e.statusText||e.status)}}).catch(function(e){t.error("failed to load library docu from '"+u+"': "+e.message+", "+e);a(l)})})};o.prototype._getReleaseNotes=function(e,o,i){var s=this;this._loadLibraryMetadata(e,function(l){if(!l.data){i({});return}var f=o.split(".").length===3&&!/-SNAPSHOT/.test(o);var u=a(o);var c=u.getMajor();var p=u.getMinor();var d=u.getPatch();var h=n(l.data).find("appData").find("releasenotes");var y=h.attr("url");var m=typeof s.getResourceUrl==="function";if(!y){t.warning("failed to load release notes for library "+e);i({});return}if(u.getSuffix()==="-SNAPSHOT"){if(p%2!=0){p=p+1;d=0}o=c+"."+p+"."+d}var g=m?s.getResourceUrl(""):window.location.href,b=/\/\d.\d{1,2}.\d{1,2}\//;if(h.attr("resolve")=="lib"){if(b.test(g)||f===false){y=l.url+y}else{y="{major}.{minor}.{patch}/"+l.url+y}}y=y.replace(/\{major\}/g,c);y=y.replace(/\{minor\}/g,p);y=y.replace(/\{patch\}/g,d);if(m){y=s.getResourceUrl(y)}r(y,{headers:{Accept:r.ContentTypes.JSON}}).then(function(e){if(e.ok){return e.json().then(function(e){i(e,o)})}else{throw new Error(e.statusText||e.status)}}).catch(function(r){if(r.name==="SyntaxError"){t.error("failed to parse release notes for library '"+e+", "+r)}else{t.warning("failed to load release notes for library '"+e+", "+r)}i({})})})};o.prototype._getLibraryComponentInfo=function(e){var t={};var r=[];var a="";e.find("ownership > component").each(function(e,t){if(t.childElementCount===0){a=t.textContent}else{var n=t.getElementsByTagName("name");if(n&&n.length>0){n=n[0].textContent;var o=t.getElementsByTagName("module");if(n&&o&&o.length>0){var i=[];for(var s=0;s<o.length;s++){var l=o[s].textContent.replace(/\//g,".");if(l){i.push(l)}}if(i.length>0){r.push({component:n,modules:i})}}}}});t["defaultComponent"]=a;if(r&&r.length>0){t["specialCases"]=r}return t};o.prototype._getActualComponent=function(e,r){function a(e,t){e=e.toLowerCase();t=t.toLowerCase();return e===t||t.match(/\*$/)&&e.indexOf(t.slice(0,-1))===0||t.match(/\.\*$/)&&e===t.slice(0,-2)}if(r){for(var n in e){if(!e[n]){t.error("No library information deployed for "+n);continue}var o;if(r.indexOf(n)===0){o=e[n].defaultComponent}var i=e[n].specialCases;if(i){for(var s=0;s<i.length;s++){var l=i[s].modules;for(var f=0;f<l.length;f++){if(a(r,l[f])){o=i[s].component}}}}if(o){return o}}}};o.prototype._getDefaultComponent=function(e){return e&&e.componentInfo&&e.componentInfo.defaultComponent};return o});