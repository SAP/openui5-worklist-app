/*
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/ui/base/ManagedObject","sap/ui/core/util/MockServerAnnotationsHandler","sap/ui/core/util/DraftEnabledMockServer","sap/ui/thirdparty/jquery","sap/ui/thirdparty/sinon"],function(e,t,r,n,s,a,o){"use strict";var i=r.extend("sap.ui.core.util.MockServer",{constructor:function(e,t,n){r.apply(this,arguments);i._aServers.push(this)},metadata:{library:"sap.ui.core",properties:{rootUri:"string",recordRequests:{type:"boolean",defaultValue:true},requests:{type:"object[]",defaultValue:[]}}},_oServer:null,_aFilter:null,_oMockdata:null,_oMetadata:null,_sMetadataUrl:null,_sMockdataBaseUrl:null,_mEntitySets:null,_oErrorMessages:{INVALID_SYSTEM_QUERY_OPTION_VALUE:"Invalid system query options value",IS_NOT_A_VALID_SYSTEM_QUERY_OPTION:"## is not a valid system query option",URI_VIOLATING_CONSTRUCTION_RULES:"The URI is violating the construction rules defined in the Data Services specification",UNSUPPORTED_FORMAT_VALUE:"Unsupported format value. Only json format is supported",MALFORMED_SYNTAX:"The Data Services Request could not be understood due to malformed syntax",RESOURCE_NOT_FOUND:"Resource not found",INVALID_SORTORDER_DETECTED:"Invalid sortorder ## detected",PROPERTY_NOT_FOUND:"Property ## not found",INVALID_FILTER_QUERY_STATEMENT:"Invalid filter query statement",INVALID_FILTER_OPERATOR:"Invalid $filter operator ##",RESOURCE_NOT_FOUND_FOR_SEGMENT:"Resource not found for the segment ##",MALFORMED_URI_LITERAL_SYNTAX_IN_KEY:"Malformed URI literal syntax in key ##",INVALID_KEY_NAME:"Invalid key name in key predicate. Expected name is ##",INVALID_KEY_PREDICATE_QUANTITY:"Invalid key predicate. The quantity of provided keys does not match the expected value",INVALID_KEY_TYPE:"Invalid key predicate. The key literal for key property ## does not match its type."},_oRandomSeed:{}});i.prototype._getPseudoRandomNumber=function(e){if(!this._oRandomSeed){this._oRandomSeed={}}if(!this._oRandomSeed.hasOwnProperty(e)){this._oRandomSeed[e]=0}this._oRandomSeed[e]=(this._oRandomSeed[e]+11)*25214903917%0xffffffffffff;return this._oRandomSeed[e]/0xffffffffffff};i.prototype._resetPseudoRandomNumberGenerator=function(){this._oRandomSeed={}};i.prototype.start=function(){this._oServer=i._getInstance();this._aFilters=[];var e=this.getRequests();var t=this;e.forEach(function(e){var r;if(t.getRecordRequests()===false&&e.response){r=function(){e.response.apply(this,arguments);t._oServer.requests=[]}}else{r=e.response}t._addRequestHandler(e.method,e.path,r)})};i.prototype.stop=function(){if(this.isStarted()){this._removeAllRequestHandlers();this._removeAllFilters();this._oServer=null}};i.prototype.attachBefore=function(e,t,r){r=r?r:"";this.attachEvent(e+r+":before",t)};i.prototype.attachAfter=function(e,t,r){r=r?r:"";this.attachEvent(e+r+":after",t)};i.prototype.detachBefore=function(e,t,r){r=r?r:"";this.detachEvent(e+r+":before",t)};i.prototype.detachAfter=function(e,t,r){r=r?r:"";this.detachEvent(e+r+":after",t)};i.prototype.isStarted=function(){return!!this._oServer};i.prototype.getEntitySetData=function(t){var r=this;var n;if(this._oMockdata&&this._oMockdata.hasOwnProperty(t)){n=a.extend(true,[],r._oMockdata[t])}else{e.error("Unrecognized EntitySet name: "+t)}return n};i.prototype.setEntitySetData=function(t,r){if(this._oMockdata&&this._oMockdata.hasOwnProperty(t)){this._oMockdata[t]=r}else{e.error("Unrecognized EntitySet name: "+t)}};i.prototype._applyQueryOnCollection=function(e,t,r,n){var s=t.split("=");var a=s[1];if(a===""){return}if(a.lastIndexOf(",")===a.length-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.URI_VIOLATING_CONSTRUCTION_RULES)}switch(s[0]){case"$top":if(!new RegExp(/^\d+$/).test(a)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}e.results=e.results.slice(0,a);break;case"$skip":if(!new RegExp(/^\d+$/).test(a)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}e.results=e.results.slice(a,e.results.length);break;case"$orderby":e.results=this._getOdataQueryOrderby(e.results,a,r);break;case"$filter":e.results=this._recursiveOdataQueryFilter(e.results,a);break;case"search-focus":break;case"search":var o="";for(var i=0;i<n.length;i++){if(n[i].indexOf("search-focus")!=-1){o=n[i].split("=")[1];break}}e.results=this._recursiveOdataQuerySearch(e.results,a,o,r);break;case"$select":e.results=this._getOdataQuerySelect(e.results,a,r);break;case"$inlinecount":var u=this._getOdataInlineCount(e.results,a);if(u){e.__count=u}break;case"$expand":e.results=this._getOdataQueryExpand(e.results,a,r);break;case"$format":e.results=this._getOdataQueryFormat(e.results,a);break;default:this._logAndThrowMockServerCustomError(400,this._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,s[0])}};i.prototype._applyQueryOnEntry=function(e,t,r){var n=t.split("=");var s=n[1];if(s===""){return}if(s.lastIndexOf(",")===s.length-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.URI_VIOLATING_CONSTRUCTION_RULES)}switch(n[0]){case"$filter":return this._recursiveOdataQueryFilter([e],s)[0];case"$select":return this._getOdataQuerySelect([e],s,r)[0];case"$expand":return this._getOdataQueryExpand([e],s,r)[0];case"$format":return this._getOdataQueryFormat([e],s);default:this._logAndThrowMockServerCustomError(400,this._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,n[0])}};i.prototype._getOdataQueryOrderby=function(e,t,r){var n=t.split(",");var s=this;a.each(n,function(e,t){n[e]=s._trim(t)});var o=function e(t,a){for(var o=0;o<n.length;o++){var i=n[o].split(" ");var u=1;if(i.length>1){switch(i[1]){case"asc":u=1;break;case"desc":u=-1;break;default:s._logAndThrowMockServerCustomError(400,s._oErrorMessages.INVALID_SORTORDER_DETECTED,i[1])}}var f,c;var d=i[0].indexOf("/");if(d!==-1){f=i[0].substring(d+1);c=i[0].substring(0,d);if(!t[c].hasOwnProperty(f)){var p=false;var l=[];if(c){var h=s._mEntitySets[r].navprops[c].to.entitySet;l=s._mEntityTypes[s._mEntitySets[h].type].properties;for(var o=0;o<l.length;o++){if(l[o].name===f){p=true;break}}}if(!p){s._logAndThrowMockServerCustomError(400,s._oErrorMessages.PROPERTY_NOT_FOUND,f)}}if(t[c][f]<a[c][f]){return-1*u}if(t[c][f]>a[c][f]){return 1*u}}else{f=i[0];if(!t.hasOwnProperty(f)){s._logAndThrowMockServerCustomError(400,s._oErrorMessages.PROPERTY_NOT_FOUND,f)}if(t[f]<a[f]){return-1*u}if(t[f]>a[f]){return 1*u}}}return 0};return e.sort(o)};i.prototype._arrayUnique=function(e){var t=e.concat();for(var r=0;r<t.length;++r){for(var n=r+1;n<t.length;++n){if(t[r]===t[n]){t.splice(n--,1)}}}return t};i.prototype._getBracketIndices=function(e){var t=[];var r=0;var n,s=0;for(var a=0;a<e.length;a++){if(e[a]==="("){if(/[substringof|endswith|startswith]$/.test(e.substring(0,a))){++r}else{t.push(e[a]);if(n===undefined){n=a}}}else if(e[a]===")"){if(!r){t.pop();s=a;if(t.length===0){return{start:n,end:s}}}else{--r}}}return{start:n,end:s}};i.prototype._recursiveOdataQueryFilter=function(e,t){var r=this._getBracketIndices(t);if(r.start===0&&r.end===t.length-1){t=this._trim(t.substring(r.start+1,r.end));return this._recursiveOdataQueryFilter(e,t)}var n=/([^substringof|endswith|startswith]|^)\((.*)\)/,s,a;var o;if(n.test(t)){var i=t.substring(r.start,r.end+1);var u=new RegExp("(.*) +(or|and) +("+this._trim(this._escapeStringForRegExp(i))+".*)");if(r.start===0){u=new RegExp("("+this._trim(this._escapeStringForRegExp(i))+") +(or|and) +(.*)")}var f=u.exec(t);if(f===null){return this._getOdataQueryFilter(e,this._trim(t))}var c=f[1];o=f[2];var d=f[3];var p=this._recursiveOdataQueryFilter(e,c);if(o==="or"){s=this._recursiveOdataQueryFilter(e,d);return this._arrayUnique(p.concat(s))}if(o==="and"){return this._recursiveOdataQueryFilter(p,d)}}else{a=t.split(/ +and | or +/);if(a.length===1){return this._getOdataQueryFilter(e,this._trim(t))}var l=this._recursiveOdataQueryFilter(e,a[0]);var h;for(var v=1;v<a.length;v++){h=new RegExp(this._trim(this._escapeStringForRegExp(a[v-1]))+" +(and|or) +"+this._trim(this._escapeStringForRegExp(a[v])));o=h.exec(t)[1];if(o==="or"){s=this._recursiveOdataQueryFilter(e,a[v]);l=this._arrayUnique(l.concat(s))}if(o==="and"){l=this._recursiveOdataQueryFilter(l,a[v])}}return l}};i.prototype._getOdataQueryFilter=function(t,r){if(t.length===0){return t}var n=new RegExp("(.*) (eq|ne|gt|lt|le|ge) (.*)");var s=new RegExp("(endswith|startswith|substringof)\\((.*)");var a=null;var o=n.exec(r);if(o){a=o[2]}else{o=s.exec(r);if(o){a=o[1]}else{this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_FILTER_QUERY_STATEMENT)}}var i=this;var u=function(s,a,o,u){var f,c,d;if(!s){f=n.exec(r);c=i._trim(f[a+1]);d=i._trim(f[o+1])}else{var p=new RegExp("(substringof|startswith|endswith)\\(([^\\)]*),(.*)\\)");f=p.exec(r);c=i._trim(f[a+2]);d=i._trim(f[o+2])}if(/^\(.+\)$/.test(c)){c=c.replace(/^\(|\)$/g,"")}if(c.indexOf("datetime")===0){c=i._getJsonDate(c)}else if(c.indexOf("guid")===0){c=c.substring(5,c.length-1)}else if(c==="true"){c=true}else if(c==="false"){c=false}else if(i._isValidNumber(c)){c=parseFloat(c)}else if(c.charAt(0)==="'"&&c.charAt(c.length-1)==="'"){c=c.substr(1,c.length-2)}var l=d.indexOf("/");if(l!==-1){var h=d.substring(l+1);var v=d.substring(0,l);if(t[0][v]){if(!t[0][v].hasOwnProperty(h)){var _=i._oErrorMessages.PROPERTY_NOT_FOUND.replace("##","'"+h+"'");e.error("MockServer: navigation property '"+v+"' was not expanded, so "+_);return t}}else{i._logAndThrowMockServerCustomError(400,i._oErrorMessages.PROPERTY_NOT_FOUND,d)}return u(d,c,v,h)}else{if(!t[0].hasOwnProperty(d)){i._logAndThrowMockServerCustomError(400,i._oErrorMessages.PROPERTY_NOT_FOUND,d)}return u(d,c)}};switch(a){case"substringof":return u(true,0,1,function(e,r,n,s){return t.filter(function(t){if(n&&s){return typeof t[n][s]==="string"&&t[n][s].indexOf(r)!==-1}return typeof t[e]==="string"&&t[e].indexOf(r)!==-1})});case"startswith":return u(true,1,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return typeof t[n][s]==="string"&&t[n][s].indexOf(r)===0}return typeof t[e]==="string"&&t[e].indexOf(r)===0})});case"endswith":return u(true,1,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return typeof t[n][s]==="string"&&t[n][s].indexOf(r)===t[n][s].length-r.length}return typeof t[e]==="string"&&t[e].indexOf(r)===t[e].length-r.length})});case"eq":return u(false,2,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return t[n][s]===r}return t[e]===r})});case"ne":return u(false,2,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return t[n][s]!==r}return t[e]!==r})});case"gt":return u(false,2,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return t[n][s]>r}return t[e]>r})});case"lt":return u(false,2,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return t[n][s]<r}return t[e]<r})});case"ge":return u(false,2,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return t[n][s]>=r}return t[e]>=r})});case"le":return u(false,2,0,function(e,r,n,s){return t.filter(function(t){if(n&&s){return t[n][s]<=r}return t[e]<=r})});default:this._logAndThrowMockServerCustomError(400,i._oErrorMessages.INVALID_FILTER_OPERATOR,a)}};i.prototype._recursiveOdataQuerySearch=function(e,t,r,n){var s="";if(r==""||r==undefined){for(var a=0;a<this._mEntitySets[n].keys.length;a++){if(a!=0){s=s+" or "}s=s+"startswith("+this._mEntitySets[n].keys[a]+",'"+t+"')"}}else{s="substringof('"+t+"',"+r+")"}return this._recursiveOdataQueryFilter(e,s)};i.prototype._getOdataQuerySelect=function(e,t,r){var n=this;var s=t.split(",");var o=[];var i=e[0]?e[0][s[0].split("/")[0]]:null;if(!(i!=null&&i.results&&i.results.length>0)){var u=function(e,t,s,o){a.each(e,function(e,i){if(t["__metadata"]){s["__metadata"]=t["__metadata"]}if(i.indexOf("/")>-1){var f=i.split("/");var c=f[0];var d=f.splice(1).join("/");s[c]=s[c]||{};if(t[c]&&t[c].results){var p=s[c].results=s[c].results||[];a.each(t[c].results,function(e,t){p[e]=u([d],t,p[e]||{},c)})}else{s[c]=u([d],t[c],s[c]||{},c)}}else{if(t&&!t.hasOwnProperty(i)){var l=false;var h=[];if(o){var v=n._mEntitySets[r].navprops[o].to.entitySet;h=n._mEntityTypes[n._mEntitySets[v].type].properties;for(var e=0;e<h.length;e++){if(h[e].name===i){l=true;break}}}if(!l){n._logAndThrowMockServerCustomError(404,n._oErrorMessages.RESOURCE_NOT_FOUND_FOR_SEGMENT,i)}}s[i]=t[i]}});return s};if(s.indexOf("*")!==-1){return e}a.each(s,function(e,t){s[e]=n._trim(t)});a.each(e,function(e,t){o.push(u(s,t,{}))})}else{var f=function(e,t,r){var n={};r=r||"";if(typeof e!=="object"){return e}if(typeof e.slice==="function"){return e.map(function(e,n){return f(e,t,r)})}if(e.__metadata!==undefined&&r.length===0){n.__metadata=e.__metadata}t.filter(function(e){return(e+"/").indexOf(r)===0}).forEach(function(t,s,a){var o=t.substr(r.length).split("/")[0];if(e[o]!==undefined){n[o]=f(e[o],a,r+o+"/")}});if(e.results!==undefined){n.results=f(e.results,t,r)}return n};o=f(e,s)}return o};i.prototype._getOdataInlineCount=function(e,t){var r=t.split(",");if(r.length!==1||r[0]!=="none"&&r[0]!=="allpages"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_SYSTEM_QUERY_OPTION_VALUE)}if(r[0]==="none"){return}return e.length};i.prototype._getOdataQueryFormat=function(e,t){if(t!=="json"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.UNSUPPORTED_FORMAT_VALUE)}return e};i.prototype._getOdataQueryExpand=function(e,t,r){var n=this;var s=t.split(",");a.each(s,function(e,t){s[e]=n._trim(t)});var o=n._mEntitySets[r].navprops;a.each(e,function(e,t){a.each(s,function(e,s){var i=s.split("/");var u=i[0];if(!t[u]){n._logAndThrowMockServerCustomError(404,n._oErrorMessages.RESOURCE_NOT_FOUND_FOR_SEGMENT,u)}var f=t[u].results||t[u];if(!f||f.__deferred){f=a.extend(true,[],n._resolveNavigation(r,t,u,t))}else if(!Array.isArray(f)){f=[f]}if(f&&i.length>1){var c=i.splice(1,i.length).join("/");f=n._getOdataQueryExpand(f,c,o[u].to.entitySet)}if(o[u].to.multiplicity==="*"){t[u]={results:f}}else{t[u]=f[0]?f[0]:{}}})});return e};i.prototype._refreshData=function(){var e=this._loadMetadata(this._sMetadataString);if(!e){return}this._mEntitySets=this._findEntitySets(this._oMetadata);this._mEntityTypes=this._findEntityTypes(this._oMetadata);if(!this._sMockdataBaseUrl){this._generateMockdata(this._mEntitySets,this._oMetadata)}else{if(!this._sMockdataBaseUrl.endsWith("/")&&!this._sMockdataBaseUrl.endsWith(".json")){this._sMockdataBaseUrl+="/"}this._loadMockdata(this._mEntitySets,this._sMockdataBaseUrl)}};i.prototype._getRootUri=function(){var e=this.getRootUri();e=e&&/([^?#]*)([?#].*)?/.exec(e)[1];return e};i.prototype._loadMetadata=function(t){var t;t=t.trim();if(t.substring(0,1)!=="<"){t=u({url:t,dataType:"text"}).data;if(!t){e.error('MockServer: The metadata for url "'+t+'" could not be found!')}}this._sMetadata=t;try{this._oMetadata=a.parseXML(t)}catch(t){e.error("MockServer: Invalid metadata XML! Reason: "+t)}return this._oMetadata};i.prototype._findEntitySets=function(e){var t={};var r=a(e).find("Principal");var n=a(e).find("Dependent");a(e).find("EntitySet").each(function(e,r){var n=a(r);var s=/((.*)\.)?(.*)/.exec(n.attr("EntityType"));t[n.attr("Name")]={name:n.attr("Name"),schema:s[2],type:s[3],keys:[],keysType:{},navprops:{}}});var s=function(e,t,s,o){var i=a(s).find("End[Role='"+e+"']").attr("EntitySet");var u=a(t).find("End[Role='"+e+"']").attr("Multiplicity");var f=[];var c=a(t).find("ReferentialConstraint > [Role='"+e+"']");if(c&&c.length>0){a(c[0]).children("PropertyRef").each(function(e,t){f.push(a(t).attr("Name"))})}else{var d=o?r:n;a(d).each(function(t,r){if(e===a(r).attr("Role")){a(r).children("PropertyRef").each(function(e,t){f.push(a(t).attr("Name"))});return false}})}return{role:e,entitySet:i,propRef:f,multiplicity:u}};a.each(t,function(t,r){var n=a(e).find("EntityType[Name='"+r.type+"']");var o=a(n).find("PropertyRef");a.each(o,function(e,t){var s=a(t).attr("Name");r.keys.push(s);r.keysType[s]=a(n).find("Property[Name='"+s+"']").attr("Type")});var i=a(e).find("EntityType[Name='"+r.type+"'] NavigationProperty");a.each(i,function(t,n){var o=a(n);var i=o.attr("Relationship").split(".");var u=a(e).find("AssociationSet[Association = '"+i.join(".")+"']");var f=i.pop();var c=a(e).find("Association[Name = '"+f+"']");r.navprops[o.attr("Name")]={name:o.attr("Name"),from:s(o.attr("FromRole"),c,u,true),to:s(o.attr("ToRole"),c,u,false)}})});return t};i.prototype._findEntityTypes=function(e){var t={};a(e).find("EntityType").each(function(e,r){var n=a(r);t[n.attr("Name")]={name:n.attr("Name"),properties:[],keys:[]};n.find("Property").each(function(e,r){var s=a(r);var o=s.attr("Type");t[n.attr("Name")].properties.push({schema:o.substring(0,o.lastIndexOf(".")),type:o.substring(o.lastIndexOf(".")+1),name:s.attr("Name"),precision:s.attr("Precision"),scale:s.attr("Scale")})});n.find("PropertyRef").each(function(e,r){var s=a(r);var o=s.attr("Name");t[n.attr("Name")].keys.push(o)})});return t};i.prototype._findComplexTypes=function(e){var t={};a(e).find("ComplexType").each(function(e,r){var n=a(r);t[n.attr("Name")]={name:n.attr("Name"),properties:[]};n.find("Property").each(function(e,r){var s=a(r);var o=s.attr("Type");t[n.attr("Name")].properties.push({schema:o.substring(0,o.lastIndexOf(".")),type:o.substring(o.lastIndexOf(".")+1),name:s.attr("Name"),precision:s.attr("Precision"),scale:s.attr("Scale")})})});return t};i.prototype._createKeysString=function(e,t){var r=this;var n="";if(t){a.each(e.keys,function(s,a){if(n){n+=","}var o=t[a];if(e.keysType[a]==="Edm.String"){o=encodeURIComponent("'"+o+"'")}else if(e.keysType[a]==="Edm.DateTime"){o=r._getDateTime(o);o=encodeURIComponent(o)}else if(e.keysType[a]==="Edm.Guid"){o="guid'"+o+"'"}if(e.keys.length===1){n+=o;return n}n+=a+"="+o})}return n};i.prototype._loadMockdata=function(t,r){var n=this,s={};this._oMockdata={};var o=function(t,r){var n=u({url:t,dataType:"json"});if(n.success){if(n.data.d){if(n.data.d.results){s[r.name]=n.data.d.results}else{e.error('The mock data format for entity set "'+r.name+'" invalid')}}else{if(Array.isArray(n.data)){s[r.name]=n.data}else{e.error('The mock data for entity set "'+r.name+'" could not be loaded due to wrong format!');return false}}return true}else{if(n.status==="parsererror"){e.error('The mock data for entity set "'+r.name+'" could not be loaded due to a parsing error!')}return false}};if(r.endsWith(".json")){var i=u({url:r,dataType:"json"});if(i.success){s=i.data}else{e.warning('The mock data for all the entity types could not be found at "'+r+'"!')}}else{var f={};if(n._aEntitySetsNames&&n._aEntitySetsNames.length>0){var c;for(var d=0;d<n._aEntitySetsNames.length;d++){c=n._aEntitySetsNames[d];if(t[c]){f[c]=t[c]}}}else{f=t}a.each(f,function(t,a){if(!s[a.type]||!s[a.name]){var i=r+a.name+".json";if(!o(i,a)){e.warning('The mock data for entity set "'+a.name+'" could not be found at "'+r+'"!');var u=r+a.type+".json";if(!o(u,a)){e.warning('The mock data for entity type "'+a.type+'" could not be found at "'+r+'"!');if(n._bGenerateMissingMockData){var f={};f[a.name]=a;s[a.type]=n._generateODataMockdataForEntitySet(f,n._oMetadata)[a.name]}}}}})}a.each(t,function(e,t){n._oMockdata[e]=[];if(s[t.name]){a.each(s[t.name],function(t,r){n._oMockdata[e].push(a.extend(true,{},r))})}else if(s[t.type]){a.each(s[t.type],function(t,r){n._oMockdata[e].push(a.extend(true,{},r))})}});a.each(t,function(e,t){if(n._oMockdata[e].length>0){n._enhanceWithMetadata(t,n._oMockdata[e])}});return this._oMockdata};i.prototype._enhanceWithMetadata=function(e,r){if(r){var n=this,s=this._getRootUri(),o=e&&e.name;a.each(r,function(r,i){i.__metadata=i.__metadata||{};i.__metadata.id=s+o+"("+n._createKeysString(e,i)+")";i.__metadata.type=e.schema+"."+e.type;i.__metadata.uri=s+o+"("+n._createKeysString(e,i)+")";a.each(e.navprops,function(r,a){if(i[r]&&!t(i[r])&&!i[r]["__deferred"]){n._oMockdata[a.to.entitySet]=n._oMockdata[a.to.entitySet].concat(i[r])}i[r]={__deferred:{uri:s+o+"("+n._createKeysString(e,i)+")/"+r}}})})}};i.prototype._isRequestedKeysValid=function(e,t){if(t.length===1){var r=t[0].split("=");if(this._trim(r[0])!==e.keys[0]){t=[e.keys[0]+"="+t[0]]}}for(var n=0;n<t.length;n++){var s=this._trim(t[n].substring(0,t[n].indexOf("=")));var a=this._trim(t[n].substring(t[n].indexOf("=")+1));var o=a.charAt(0);var i=a.charAt(a.length-1);if(e.keysType[s]==="Edm.String"){if(o!=="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else if(e.keysType[s]==="Edm.DateTime"){if(o==="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else if(e.keysType[s]==="Edm.Guid"){if(o==="'"||i!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else if(e.keysType[s]==="Edm.Binary"){if(!new RegExp("(binary|X)'[A-Fa-f0-9][A-Fa-f0-9]*'").test(a)){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}else{if(o==="'"&&i!=="'"||i==="'"&&o!=="'"){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.MALFORMED_URI_LITERAL_SYNTAX_IN_KEY,s)}}var u=e.keys.join(",");if(e.keys.indexOf(s)===-1){this._logAndThrowMockServerCustomError(400,this._oErrorMessages.INVALID_KEY_NAME,u)}}};i.prototype._parseKeys=function(e,t){var r={};var n=e.split(",");var s,a,o;for(var i=0;i<n.length;i++){o=n[i].split("=");if(o.length===1&&t.keys.length===1){s=t.keys[0];a=o[0]}else{if(o.length===2){s=o[0];a=o[1]}}r[s]=a;switch(t.keysType[s]){case"Edm.String":r[s]=r[s].replace(/^\'|\'$/g,"");break;case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":r[s]=parseFloat(r[s]);break;case"Edm.Guid":r[s]=r[s].replace(/^guid\'|\'$/g,"");break;case"Edm.Boolean":case"Edm.Binary":case"Edm.DateTimeOffset":default:}}return r};i.prototype._generatePropertyValue=function(e,t,r,n){var s=n;if(!s){s=Math.floor(this._getPseudoRandomNumber("String")*1e4)+101}switch(t){case"String":return e+" "+s;case"DateTime":var a=new Date;a.setFullYear(2e3+Math.floor(this._getPseudoRandomNumber("DateTime")*20));a.setDate(Math.floor(this._getPseudoRandomNumber("DateTime")*30));a.setMonth(Math.floor(this._getPseudoRandomNumber("DateTime")*12));a.setMilliseconds(0);return"/Date("+a.getTime()+")/";case"Int16":case"Int32":case"Int64":return Math.floor(this._getPseudoRandomNumber("Int")*1e4);case"Decimal":return Math.floor(this._getPseudoRandomNumber("Decimal")*1e6)/100;case"Boolean":return this._getPseudoRandomNumber("Boolean")<.5;case"Byte":return Math.floor(this._getPseudoRandomNumber("Byte")*10);case"Double":return this._getPseudoRandomNumber("Double")*10;case"Single":return this._getPseudoRandomNumber("Single")*1e9;case"SByte":return Math.floor(this._getPseudoRandomNumber("SByte")*10);case"Time":return"PT"+Math.floor(this._getPseudoRandomNumber("Time")*23)+"H"+Math.floor(this._getPseudoRandomNumber("Time")*59)+"M"+Math.floor(this._getPseudoRandomNumber("Time")*59)+"S";case"Guid":return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=this._getPseudoRandomNumber("Guid")*16|0,r=e==="x"?t:t&3|8;return r.toString(16)}.bind(this));case"Binary":var o=Math.floor(-2147483648+this._getPseudoRandomNumber("Binary")*4294967295),i="";for(var u=0,f=o;u<32;u++,i+=String(f>>>31),f<<=1);return i;case"DateTimeOffset":var a=new Date;a.setFullYear(2e3+Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*20));a.setDate(Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*30));a.setMonth(Math.floor(this._getPseudoRandomNumber("DateTimeOffset")*12));a.setMilliseconds(0);return"/Date("+a.getTime()+"+0000)/";default:return this._generateDataFromEntity(r[t],s,r)}};i.prototype._isFalseyValue=function(e,t,r){switch(r){case"Edm.String":return e==="";case"Edm.Boolean":return e===false;case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":return e===0||isNaN(e);default:return false}};i.prototype._completeKey=function(e,t,r){if(r){for(var n=0;n<e.keys.length;n++){var s=e.keys[n];if(t[s]!==undefined&&t[s]!==null){if(!r[s]){switch(e.keysType[s]){case"Edm.DateTime":r[s]=this._getJsonDate(t[s]);break;case"Edm.Guid":r[s]=t[s].replace(/^guid\'|\'$/g,"");break;default:r[s]=t[s]}}}else{if(!r[s]){r[s]=this._generatePropertyValue(s,e.keysType[s].substring(e.keysType[s].lastIndexOf(".")+1))}}}}};i.prototype._generateDataFromEntity=function(e,t,r){var n={};if(!e){return n}for(var s=0;s<e.properties.length;s++){var a=e.properties[s];n[a.name]=this._generatePropertyValue(a.name,a.type,r,t)}return n};i.prototype._generateDataFromEntitySet=function(e,t,r){var n=t[e.type];var s=[];for(var a=0;a<100;a++){s.push(this._generateDataFromEntity(n,a+1,r))}return s};i.prototype._generateMockdata=function(e,t){var r=this;var n={};var s=this._getRootUri();a.each(e,function(e,s){var a={};a[s.name]=s;n[e]=r._generateODataMockdataForEntitySet(a,t)[e]});a.each(e,function(e,t){for(var o in t.navprops){var i=t.navprops[o];var u=i.from.propRef.length;for(var f=0;f<u;f++){for(var c=0;c<n[e].length;c++){var d=n[e][c];n[i.to.entitySet][c][i.to.propRef[f]]=d[i.from.propRef[f]]}}}a.each(n[e],function(n,o){o.__metadata={uri:s+e+"("+r._createKeysString(t,o)+")",type:t.schema+"."+t.type};a.each(t.navprops,function(n,a){o[n]={__deferred:{uri:s+e+"("+r._createKeysString(t,o)+")/"+n}}})})});this._oMockdata=n};i.prototype._generateODataMockdataForEntitySet=function(e,t){var r=this,n={};var s=this._findEntityTypes(t);var o=this._findComplexTypes(t);a.each(e,function(e,t){n[e]=r._generateDataFromEntitySet(t,s,o)});return n};i.prototype._resolveNavigation=function(e,t,r){var n=this._mEntitySets[e];var s=n.navprops[r];if(!s){this._logAndThrowMockServerCustomError(404,this._oErrorMessages.RESOURCE_NOT_FOUND)}var o=[];var i=s.from.propRef.length;if(i===0){if(s.to.multiplicity==="*"){return this._oMockdata[s.to.entitySet]}else{o.push(this._oMockdata[s.to.entitySet][0]);return o}}a.each(this._oMockdata[s.to.entitySet],function(e,r){var n=true;for(var a=0;a<i;a++){if(t[s.from.propRef[a]]!==r[s.to.propRef[a]]){n=false;break}}if(n){o.push(r)}});return o};i.prototype.simulate=function(r,o){var u=this;this._sMetadataString=r;if(!o||typeof o==="string"){this._sMockdataBaseUrl=o}else{this._sMockdataBaseUrl=o.sMockdataBaseUrl;this._bGenerateMissingMockData=o.bGenerateMissingMockData;this._aEntitySetsNames=o.aEntitySetsNames}var f=this._loadMetadata(this._sMetadataString);if(!f){return}if(this._sMetadata){var c=n.parse(this._oMetadata,this._sMetadata);s.handleDraft(c,this)}this._resetPseudoRandomNumberGenerator();this._refreshData();var d=function(e,t){if(e.requestHeaders["x-csrf-token"]==="Fetch"||e.requestHeaders["X-CSRF-Token"]==="Fetch"){t["X-CSRF-Token"]="42424242424242424242424242424242"}};var p=function(e,t){t=decodeURIComponent(t);var r;var n=u._mEntitySets[e];var s=n.keys;var o=t.split(",");if(o.length!==s.length){u._logAndThrowMockServerCustomError(400,u._oErrorMessages.INVALID_KEY_PREDICATE_QUANTITY)}u._isRequestedKeysValid(n,o);if(o.length===1&&!o[0].split("=")[1]){o=[s[0]+"="+o[0]]}a.each(u._oMockdata[e],function(e,t){for(var a=0;a<o.length;a++){var i=o[a].split("=");var f=u._trim(i[0]);if(!s||s.indexOf(f)===-1){return true}var c=u._trim(i[1]);var d=t[f];switch(n.keysType[f]){case"Edm.String":c=c.replace(/^\'|\'$/g,"");break;case"Edm.Time":case"Edm.DateTime":d=u._getDateTime(d);break;case"Edm.Int16":case"Edm.Int32":case"Edm.Decimal":case"Edm.Byte":case"Edm.Double":case"Edm.Single":case"Edm.SByte":if(!u._isValidNumber(c)){return false}c=parseFloat(c);break;case"Edm.Guid":c=c.replace(/^guid\'|\'$/g,"");break;case"Edm.Boolean":if(["true","false"].indexOf(c)===-1){u._logAndThrowMockServerCustomError(400,u._oErrorMessages.INVALID_KEY_TYPE,f)}c=c==="true";break;case"Edm.Binary":case"Edm.DateTimeOffset":default:}if(d!==c){return true}}r={index:e,entry:t};return false});return r};var l=function(e,t,r){var n=e.name;var s;if(r){s=e.navprops[r]}if(s){n=s.to.entitySet}return n};var h=function(e){var t=[];var r=function(e){var t=e.indexOf("'");var r=e.indexOf('"');if(t===-1&&r===-1){return null}else{if(t>-1&&r===-1){return"appost"}if(r>-1&&t===-1){return"doublequotes"}if(t>-1&&r>-1&&t<r){return"appost"}if(t>-1&&r>-1&&r<t){return"doublequotes"}}};var n=function(e,t,r,n){var s=e[r];var a=r+1;while(a<e.length&&e[a].indexOf(n)===-1){s=s+"&"+e[a];a++}s=s+"&"+e[a];t.push(s);r=a;return r};for(var s=0;s<e.length;s++){if(!r(e[s])){t.push(e[s])}if(r(e[s])==="appost"){var a=e[s].indexOf("'");if(e[s].indexOf("'",a+1)===-1){s=n(e,t,s,"'")}else{t.push(e[s])}}if(r(e[s])==="doublequotes"){var o=e[s].indexOf('"');if(e[s].indexOf('"',o+1)===-1){s=n(e,t,s,'"')}else{t.push(e[s])}}}return t};var v=function(e,t,r,n){r=r?decodeURIComponent(r):r;var s=JSON.parse(e.requestBody);if(s){var a={};if(r){a=u._parseKeys(r,u._mEntitySets[t])}u._completeKey(u._mEntitySets[t],a,s);u._enhanceWithMetadata(u._mEntitySets[t],[s]);return s}return null};var _=[];_.push({method:"GET",path:new RegExp("\\$metadata([?#].*)?"),response:function(t){e.debug("MockServer: incoming request for url: "+t.url);var r={"Content-Type":"application/xml;charset=utf-8"};d(t,r);t.respond(200,r,u._sMetadata);e.debug("MockServer: response sent with: 200, "+u._sMetadata);return true}});_.push({method:"HEAD",path:new RegExp("$"),response:function(t){e.debug("MockServer: incoming request for url: "+t.url);var r={"Content-Type":"application/json;charset=utf-8"};d(t,r);t.respond(200,r);e.debug("MockServer: response sent with: 200");return true}});_.push({method:"GET",path:new RegExp("$"),response:function(t){e.debug("MockServer: incoming request for url: "+t.url);var r={"Content-Type":"application/json;charset=utf-8"};d(t,r);var n=[];a.each(u._mEntitySets,function(e,t){n.push(e)});var s={EntitySets:n};t.respond(200,r,JSON.stringify({d:s}));e.debug("MockServer: response sent with: 200, "+JSON.stringify({d:s}));return true}});_.push({method:"POST",path:new RegExp("\\$batch([?#].*)?"),response:function(t){e.debug("MockServer: incoming request for url: "+t.url);var r=function(e){switch(e.statusCode){case 200:return"200 OK";case 201:return"201 Created";case 204:return"204 No Content";case 400:return"400 Bad Request";case 401:return"401 Unauthorized";case 403:return"403 Forbidden";case 404:return"404 Not Found";case 405:return"405 Method Not Allowed";case 409:return"409 Conflict";case 412:return"412 Precondition Failed";case 415:return"415 Unsupported Media Type";case 500:return"500 Internal Server Error";case 501:return"501 Not Implemented";case 503:return"503 Service Unavailable";default:return e.statusCode+" "+e.status}};var n=function(e,t){var n;if(e.success){n=JSON.stringify(e.data)||""}else{n=e.errorResponse}t=t||"application/json";if(e.responseHeaders){return"HTTP/1.1 "+r(e)+"\r\n"+e.responseHeaders+"dataserviceversion: 2.0\r\n\r\n"+n+"\r\n"}else{return"HTTP/1.1 "+r(e)+"\r\nContent-Type: "+t+"\r\nContent-Length: "+n.length+"\r\ndataserviceversion: 2.0\r\n\r\n"+n+"\r\n"}};var s=function(e,t,r,s,o){var i;var u=function(e,t,r){i={success:true,data:e,status:t,statusCode:r&&r.status,responseHeaders:r&&r.getAllResponseHeaders()}};var f=function(e,t,r){i={success:false,data:undefined,status:t,error:r,statusCode:e.status,errorResponse:e.responseText,responseHeaders:e&&e.getAllResponseHeaders()}};a.ajax({type:r,async:false,url:e,headers:o,data:t,dataType:"json",success:u,error:f});if(i.statusCode===400||i.statusCode===404){var c=n(i);throw new Error(c)}s.push(n(i))};var o=function(e,t){var r;var s;var o=function(e,t,n){r={success:true,data:e,status:t,statusCode:n&&n.status,responseHeaders:n&&n.getAllResponseHeaders()}};var i=function(e,t,n){r={success:false,data:undefined,status:t,error:n,statusCode:e.status,errorResponse:e.responseText,responseHeaders:e&&e.getAllResponseHeaders()}};a.ajax({async:false,url:e,dataType:"json",success:o,error:i});var s;if(e.indexOf("$count")!==-1){s=n(r,"text/plain")}else{s=n(r)}t.push("\r\nContent-Type: application/http\r\n"+"Content-Length: "+s.length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+s)};var i=function(e){var t={};e.split("HTTP/1.1")[1].split("{")[0].split("\n").forEach(function(e){if(e.indexOf(":")!==-1){var r=e.split(":");t[r[0].trim()]=r[1].trim()}});delete t["Content-Length"];return t};var f=t.requestBody;var c=new RegExp("--batch_[a-z0-9-]*");var p=c.exec(f)[0];if(p){var l=[];var h=f.split(p);var v=t.url.split("$")[0];var _=new RegExp("PUT (.*) HTTP");var E=new RegExp("MERGE (.*) HTTP");var y=new RegExp("POST (.*) HTTP");var g=new RegExp("DELETE (.*) HTTP");var m=new RegExp("GET (.*) HTTP");for(var T=1;T<h.length-1;T++){var S=h[T];if(m.test(S)&&S.indexOf("multipart/mixed")===-1){if(_.test(S)||y.test(S)||g.test(S)){t.respond(400,null,"The Data Services Request could not be understood due to malformed syntax");e.debug("MockServer: response sent with: 400");return true}o(v+m.exec(S)[1],l)}else{var M=a.extend(true,{},u._oMockdata);var O=[];var R=S.substring(S.indexOf("boundary=")+9,S.indexOf("\r\n\r\n"));var k=S.split("--"+R);try{for(var b=1;b<k.length-1;b++){var N=k[b];var x;if(m.test(N)){u._oMockdata=M;t.respond(400,null,"The Data Services Request could not be understood due to malformed syntax");e.debug("MockServer: response sent with: 400");return}else{var x=N.substring(N.indexOf("{"),N.lastIndexOf("}")+1),D=i(N),P,I;if(_.test(N)){I="PUT";P=_.exec(N)[1]}else if(E.test(N)){I="MERGE";P=E.exec(N)[1]}else if(y.test(N)){I="POST";P=y.exec(N)[1]}else if(g.test(N)){I="DELETE";x=undefined;P=g.exec(N)[1]}s(v+P,x,I,O,D)}}var w="\r\nContent-Type: multipart/mixed; boundary=ejjeeffe1\r\n\r\n--ejjeeffe1";for(var A=0;A<O.length;A++){w+="\r\nContent-Type: application/http\r\n"+"Content-Length: "+O[A].length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+O[A]+"--ejjeeffe1"}w+="--\r\n";l.push(w)}catch(e){u._oMockdata=M;var C="\r\nContent-Type: application/http\r\n"+"Content-Length: "+e.message.length+"\r\n"+"content-transfer-encoding: binary\r\n\r\n"+e.message;l.push(C)}}}var H="--ejjeeffe0";for(var U=0;U<l.length;U++){H+=l[U]+"--ejjeeffe0"}H+="--";var D={"Content-Type":"multipart/mixed; boundary=ejjeeffe0"};d(t,D);t.respond(202,D,H);e.debug("MockServer: response sent with: 202, "+H)}else{t.respond(202)}return true}});a.each(this._mEntitySets,function(r,n){_.push({method:"GET",path:new RegExp("("+r+")/\\$count/?(.*)?"),response:function(t,r,n){e.debug("MockServer: incoming request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.GET+r+":before",{oXhr:t,sUrlParams:n});u.fireEvent(i.HTTPMETHOD.GET+":before",{oXhr:t,sUrlParams:n});var s={"Content-Type":"text/plain;charset=utf-8"};d(t,s);try{var o=u._oMockdata[r];if(o){var f={results:a.extend(true,[],o)};if(n){var c=decodeURIComponent(n).replace("?","&").split("&");c=h(c);if(c.length>1){c=u._orderQueryOptions(c)}a.each(c,function(e,t){u._applyQueryOnCollection(f,t,r,c)})}u.fireEvent(i.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:f});u.fireEvent(i.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:f});t.respond(200,s,""+f.results.length);e.debug("MockServer: response sent with: 200, "+f.results.length)}else{u._logAndThrowMockServerCustomError(404,u._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,s,JSON.stringify(r))}else{e.error("MockServer: request failed due to invalid system query options value!");t.respond(parseInt(r.message||r.number))}}return true}});_.push({method:"GET",path:new RegExp("("+r+")/?(\\?(.*))?"),response:function(t,r,n){e.debug("MockServer: incoming request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.GET+r+":before",{oXhr:t,sUrlParams:n});u.fireEvent(i.HTTPMETHOD.GET+":before",{oXhr:t,sUrlParams:n});var s={"Content-Type":"application/json;charset=utf-8"};d(t,s);try{var o=u._oMockdata[r];if(o){var f={results:a.extend(true,[],o)};if(n){var c=decodeURIComponent(n).replace("?","&").split("&");c=h(c);if(c.length>1){c=u._orderQueryOptions(c)}a.each(c,function(e,t){u._applyQueryOnCollection(f,t,r,c)})}u.fireEvent(i.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:f});u.fireEvent(i.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:f});t.respond(200,s,JSON.stringify({d:f}));e.debug("MockServer: response sent with: 200, "+JSON.stringify({d:f}))}else{u._logAndThrowMockServerCustomError(404,u._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,s,JSON.stringify(r))}else{e.debug("MockServer: response sent with: "+parseInt(r.message||r.number));t.respond(parseInt(r.message||r.number))}}return true}});_.push({method:"GET",path:new RegExp("("+r+")\\(([^/\\?#]+)\\)/?(\\?(.*))?"),response:function(r,n,s,o){e.debug("MockServer: incoming request for url: "+r.url);u.fireEvent(i.HTTPMETHOD.GET+n+":before",{oXhr:r,sKeys:s,sUrlParams:o});u.fireEvent(i.HTTPMETHOD.GET+":before",{oXhr:r,sKeys:s,sUrlParams:o});var f={"Content-Type":"application/json;charset=utf-8"};try{var c=a.extend(true,{},p(n,s));if(!t(c)){if(o){var d=decodeURIComponent(o).replace("?","&").split("&");d=h(d);if(d.length>1){d=u._orderQueryOptions(d)}a.each(d,function(e,t){c.entry=u._applyQueryOnEntry(c.entry,t,n)})}u.fireEvent(i.HTTPMETHOD.GET+n+":after",{oXhr:r,oEntry:c.entry});u.fireEvent(i.HTTPMETHOD.GET+":after",{oXhr:r,oEntry:c.entry});r.respond(200,f,JSON.stringify({d:c.entry}));e.debug("MockServer: response sent with: 200, "+JSON.stringify({d:c.entry}))}else{u._logAndThrowMockServerCustomError(404,u._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(t){if(t.error){r.respond(t.error.code,f,JSON.stringify(t))}else{e.debug("MockServer: response sent with: "+parseInt(t.message||t.number));r.respond(parseInt(t.message||t.number))}}return true}});a.each(n.navprops,function(t,n){_.push({method:"GET",path:new RegExp("("+r+")\\(([^/\\?#]+)\\)/("+t+")/\\$count/?(.*)?"),response:function(t,r,n,s,o){e.debug("MockServer: incoming request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.GET+r+":before",{oXhr:t,sKeys:n,sNavProp:s,sUrlParams:o});u.fireEvent(i.HTTPMETHOD.GET+":before",{oXhr:t,sKeys:n,sNavProp:s,sUrlParams:o});var f={"Content-Type":"text/plain;charset=utf-8"};d(t,f);try{var c=p(r,n);if(c){var l,v={};l=u._resolveNavigation(r,c.entry,s);var _=u._mEntitySets[r].navprops[s].to.multiplicity;if(_==="*"){v={results:a.extend(true,[],l)}}else{v=a.extend(true,{},l[0])}if(l&&l.length!==0){if(o){var E=decodeURIComponent(o).replace("?","&").split("&");E=h(E);if(E.length>1){E=u._orderQueryOptions(E)}if(_==="*"){a.each(E,function(e,t){u._applyQueryOnCollection(v,t,u._mEntitySets[r].navprops[s].to.entitySet,E)})}else{a.each(E,function(e,t){v=u._applyQueryOnEntry(v,t,u._mEntitySets[r].navprops[s].to.entitySet)})}}}u.fireEvent(i.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:v});u.fireEvent(i.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:v});v.results=v.results||[];t.respond(200,f,""+v.results.length);e.debug("MockServer: response sent with: 200, "+v.results.length)}else{u._logAndThrowMockServerCustomError(404,u._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,f,JSON.stringify(r))}else{e.debug("MockServer: response sent with: "+parseInt(r.message||r.number));t.respond(parseInt(r.message||r.number))}}return true}});_.push({method:"GET",path:new RegExp("("+r+")\\(([^/\\?#]+)\\)/("+t+")/?(\\?(.*))?"),response:function(t,r,n,s,o){e.debug("MockServer: incoming request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.GET+r+":before",{oXhr:t,sKeys:n,sNavProp:s,sUrlParams:o});u.fireEvent(i.HTTPMETHOD.GET+":before",{oXhr:t,sKeys:n,sNavProp:s,sUrlParams:o});var f={"Content-Type":"application/json;charset=utf-8"};d(t,f);try{var c=p(r,n);if(c){var l,v={};l=u._resolveNavigation(r,c.entry,s,c.entry);var _=u._mEntitySets[r].navprops[s].to.multiplicity;if(_==="*"){v={results:a.extend(true,[],l)}}else{v=a.extend(true,{},l[0])}if(l&&l.length!==0){if(o){var E=decodeURIComponent(o).replace("?","&").split("&");E=h(E);if(E.length>1){E=u._orderQueryOptions(E)}if(_==="*"){a.each(E,function(e,t){u._applyQueryOnCollection(v,t,u._mEntitySets[r].navprops[s].to.entitySet,E)})}else{a.each(E,function(e,t){v=u._applyQueryOnEntry(v,t,u._mEntitySets[r].navprops[s].to.entitySet)})}}}u.fireEvent(i.HTTPMETHOD.GET+r+":after",{oXhr:t,oFilteredData:v});u.fireEvent(i.HTTPMETHOD.GET+":after",{oXhr:t,oFilteredData:v});t.respond(200,f,JSON.stringify({d:v}));e.debug("MockServer: response sent with: 200, "+JSON.stringify({d:v}))}else{u._logAndThrowMockServerCustomError(404,u._oErrorMessages.RESOURCE_NOT_FOUND)}}catch(r){if(r.error){t.respond(r.error.code,f,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number));e.debug("MockServer: response sent with: "+parseInt(r.message||r.number))}}return true}})});_.push({method:"POST",path:new RegExp("("+r+")(\\(([^/\\?#]+)\\)/?(.*)?)?"),response:function(t,r,s,o,f){var c=false;if(t.requestHeaders["x-http-method"]==="MERGE"){c=true}e.debug("MockServer: incoming create request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.POST+r+":before",{oXhr:t,sKeys:o,sNavName:f});u.fireEvent(i.HTTPMETHOD.POST+":before",{oXhr:t,sKeys:o,sNavName:f});var d=null;var h=null;var _=405;try{if(o&&!o.split("=")[1]){o=u._mEntitySets[r].keys[0]+"="+o}var E=l(n,decodeURIComponent(o),f);if(E){var y=v(t,E,o,f);if(y){h={"Content-Type":"application/json;charset=utf-8"};u.fireEvent(i.HTTPMETHOD.POST+r+":after",{oXhr:t,oEntity:y});u.fireEvent(i.HTTPMETHOD.POST+":after",{oXhr:t,oEntity:y});if(c){var g=p(r,o);if(g){a.extend(u._oMockdata[r][g.index],y)}_=204}else{var m=u._getRootUri()+E+"("+u._createKeysString(u._mEntitySets[E],y)+")";d=JSON.stringify({d:y,uri:m});u._oMockdata[E]=u._oMockdata[E].concat([y]);_=201}}}t.respond(_,h,d);e.debug("MockServer: response sent with: "+_+", "+d)}catch(r){if(r.error){var T={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,T,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number));e.debug("MockServer: response sent with: "+parseInt(r.message||r.number))}}return true}});_.push({method:"PUT",path:new RegExp("("+r+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,r,s,a){e.debug("MockServer: incoming update request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.PUT+r+":before",{oXhr:t,sKeys:s,sNavName:a});u.fireEvent(i.HTTPMETHOD.PUT+":before",{oXhr:t,sKeys:s,sNavName:a});var o=405;var f=null;var c=null;try{var d=l(n,decodeURIComponent(s),a);if(d){var h=v(t,d,s,a);if(h){c={"Content-Type":"application/json;charset=utf-8"};u.fireEvent(i.HTTPMETHOD.PUT+r+":after",{oXhr:t,oEntity:h});u.fireEvent(i.HTTPMETHOD.PUT+":after",{oXhr:t,oEntity:h});var _=p(r,s);if(_){u._oMockdata[r][_.index]=h}o=204}}t.respond(o,c,f);e.debug("MockServer: response sent with: "+o+", "+f)}catch(r){if(r.error){var E={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,E,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number));e.debug("MockServer: response sent with: "+parseInt(r.message||r.number))}}return true}});_.push({method:"MERGE",path:new RegExp("("+r+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,r,s,o){e.debug("MockServer: incoming merge update request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.MERGE+r+":before",{oXhr:t,sKeys:s,sNavName:o});u.fireEvent(i.HTTPMETHOD.MERGE+":before",{oXhr:t,sKeys:s,sNavName:o});var f=405;var c=null;var d=null;try{var h=l(n,decodeURIComponent(s),o);if(h){var _=v(t,h,s,o);if(_){d={"Content-Type":"application/json;charset=utf-8"};u.fireEvent(i.HTTPMETHOD.MERGE+r+":after",{oXhr:t,oEntity:_});u.fireEvent(i.HTTPMETHOD.MERGE+":after",{oXhr:t,oEntity:_});var E=p(r,s);if(E){a.extend(u._oMockdata[r][E.index],_)}f=204}}t.respond(f,d,c);e.debug("MockServer: response sent with: "+f+", "+c)}catch(r){if(r.error){var y={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,y,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number));e.debug("MockServer: response sent with: "+parseInt(r.message||r.number))}}return true}});_.push({method:"PATCH",path:new RegExp("("+r+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,r,s,o){e.debug("MockServer: incoming patch update request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.PATCH+r+":before",{oXhr:t,sKeys:s,sNavName:o});u.fireEvent(i.HTTPMETHOD.PATCH+":before",{oXhr:t,sKeys:s,sNavName:o});var f=405;var c=null;var d=null;try{var h=l(n,decodeURIComponent(s),o);if(h){var _=v(t,h,s,o);if(_){d={"Content-Type":"application/json;charset=utf-8"};u.fireEvent(i.HTTPMETHOD.PATCH+r+":after",{oXhr:t,oEntity:_});u.fireEvent(i.HTTPMETHOD.PATCH+":after",{oXhr:t,oEntity:_});var E=p(r,s);if(E){a.extend(u._oMockdata[r][E.index],_)}f=204}}t.respond(f,d,c);e.debug("MockServer: response sent with: "+f+", "+c)}catch(r){if(r.error){var y={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,y,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number));e.debug("MockServer: response sent with: "+parseInt(r.message||r.number))}}return true}});_.push({method:"DELETE",path:new RegExp("("+r+")\\(([^/\\?#]+)\\)/?(.*)?"),response:function(t,r,n,s){e.debug("MockServer: incoming delete request for url: "+t.url);u.fireEvent(i.HTTPMETHOD.DELETE+r+":before",{oXhr:t});u.fireEvent(i.HTTPMETHOD.DELETE+":before",{oXhr:t});var a=204;try{var o=p(r,n);if(o){u._oMockdata[r].splice(o.index,1)}else{a=400}u.fireEvent(i.HTTPMETHOD.DELETE+r+":after",{oXhr:t});u.fireEvent(i.HTTPMETHOD.DELETE+":after",{oXhr:t});t.respond(a,null,null);e.debug("MockServer: response sent with: "+a)}catch(r){if(r.error){var f={"Content-Type":"text/plain;charset=utf-8"};t.respond(r.error.code,f,JSON.stringify(r))}else{t.respond(parseInt(r.message||r.number));e.debug("MockServer: response sent with: "+parseInt(r.message||r.number))}}return true}})});this.setRequests(_)};i.prototype._orderQueryOptions=function(e){var t,r,n,s,o,i,u,f,c,d,p=[];var l=this;a.each(e,function(a,p){var h=e.indexOf(p);switch(p.split("=")[0]){case"$top":s=h;break;case"$skip":n=h;break;case"$orderby":o=h;break;case"$expand":u=h;break;case"$filter":t=h;break;case"$select":i=h;break;case"$inlinecount":r=h;break;case"$format":f=h;break;case"search-focus":d=h;break;case"search":c=h;break;default:if(p.split("=")[0].indexOf("$")===0){l._logAndThrowMockServerCustomError(400,l._oErrorMessages.IS_NOT_A_VALID_SYSTEM_QUERY_OPTION,p.split("=")[0])}}});if(u>=0){p.push(e[u])}if(t>=0){p.push(e[t])}if(d>=0){p.push(e[d])}if(c>=0){p.push(e[c])}if(r>=0){p.push(e[r])}if(o>=0){p.push(e[o])}if(n>=0){p.push(e[n])}if(s>=0){p.push(e[s])}if(i>=0){p.push(e[i])}if(f>=0){p.push(e[f])}return p};i.prototype._removeAllRequestHandlers=function(){var e=this.getRequests();var t=e.length;for(var r=0;r<t;r++){i._removeResponse(e[r].response)}};i.prototype._removeAllFilters=function(){for(var e=0;e<this._aFilters.length;e++){i._removeFilter(this._aFilters[e])}this._aFilters=null};i.prototype._addRequestHandler=function(t,r,n){t=t?t.toUpperCase():t;if(typeof t!=="string"){throw new Error("Error in request configuration: value of 'method' has to be a string")}if(!(typeof r==="string"||r instanceof RegExp)){throw new Error("Error in request configuration: value of 'path' has to be a string or a regular expression")}if(typeof n!=="function"){throw new Error("Error in request configuration: value of 'response' has to be a function")}var s=this._getRootUri();s=s&&new RegExp(this._escapeStringForRegExp(s));if(r&&!(r instanceof RegExp)){r=new RegExp(this._createRegExpPattern(r))}var a=this._createRegExp(s?s.source+r.source:r.source);this._addFilter(this._createFilter(t,a));this._oServer.respondWith(t,a,n);e.debug("MockServer: adding "+t+" request handler for pattern "+a)};i.prototype._createRegExp=function(e){return new RegExp("^"+e+"$")};i.prototype._createRegExpPattern=function(e){return e.replace(/:([\w\d]+)/g,"([^/]+)")};i.prototype._escapeStringForRegExp=function(e){return e.replace(/[\\\/\[\]\{\}\(\)\-\*\+\?\.\^\$\|]/g,"\\$&")};i.prototype._trim=function(e){return e&&e.replace(/^\s+|\s+$/g,"")};i.prototype._isValidNumber=function(e){if(/^([-+]?)0*(\d+)(\.\d+|)([eE][-+]?\d+[d]?|[mldf])?$/i.test(e)){var t=parseFloat(e);return!isNaN(t)&&isFinite(t)}return false};i.prototype._getDateTime=function(e){if(!e){return}return"datetime'"+new Date(Number(e.replace("/Date(","").replace(")/",""))).toJSON().substring(0,19)+"'"};i.prototype._getJsonDate=function(e){if(!e){return}var t=function(e){var t=a.map(e.slice(0,-5).split(/\D/),function(e){return parseInt(e)||0});t[1]-=1;t=new Date(Date.UTC.apply(Date,t));var r=e.slice(-5);var n=parseInt(r)/100;if(r.slice(0,1)==="+"){n*=-1}t.setHours(t.getHours()+n);return t.getTime()};if(e.indexOf("datetimeoffset")>-1){return"/Date("+t(e.substring("datetimeoffset'".length,e.length-1))+")/"}else{return"/Date("+t(e.substring("datetime'".length,e.length-1))+")/"}};i.prototype._addFilter=function(e){this._aFilters.push(e);i._addFilter(e)};i.prototype._createFilter=function(e,t){return function(r,n,s,a,o){return e===r&&t.test(n)}};i.prototype._logAndThrowMockServerCustomError=function(t,r,n){if(r.indexOf("##")>-1&&n){r=r.replace("##","'"+n+"'")}e.error("MockServer: "+r);throw{error:{code:t,message:{lang:"en",value:r}}}};i.prototype.destroy=function(e){r.prototype.destroy.apply(this,arguments);this.stop();var t=i._aServers;var n=t.indexOf(this);t.splice(n,1)};i._aFilters=[];i._oServer=null;i._aServers=[];i._getInstance=function(){if(!this._oServer){this._oServer=window.sinon.fakeServer.create();this._oServer.autoRespond=true}return this._oServer};i.config=function(e){var t=this._getInstance();t.autoRespond=e.autoRespond===false?false:true;t.autoRespondAfter=e.autoRespondAfter||0;t.fakeHTTPMethods=e.fakeHTTPMethods||false};i.respond=function(){this._getInstance().respond()};i.startAll=function(){for(var e=0;e<this._aServers.length;e++){this._aServers[e].start()}};i.stopAll=function(){for(var e=0;e<this._aServers.length;e++){this._aServers[e].stop()}this._getInstance().restore();this._oServer=null};i.destroyAll=function(){this.stopAll();while(this._aServers.length>0){this._aServers[0].destroy()}};i.HTTPMETHOD={GET:"GET",POST:"POST",DELETE:"DELETE",PUT:"PUT",MERGE:"MERGE",PATCH:"PATCH"};i._addFilter=function(e){this._aFilters.push(e)};i._removeFilter=function(e){this._aFilters.splice(this._aFilters.indexOf(e),1)};i._removeResponse=function(e){var t=this._oServer.responses;var r=t.length;for(var n=0;n<r;n++){if(t[n].response===e){t.splice(n,1);return true}}return false};function u(e){var t;Object.assign(e,{async:false,success:function(e,r,n){t={success:true,data:e,status:r,statusCode:n&&n.status}},error:function(e,r,n){t={success:false,data:undefined,status:r,error:n,statusCode:e.status,errorResponse:e.responseText}}});a.ajax(e);return t}i._syncAjax=u;window.sinon.FakeXMLHttpRequest.useFilters=true;window.sinon.FakeXMLHttpRequest.addFilter(function(e,t,r,n,s){var a=i._aFilters;for(var o=0;o<a.length;o++){var u=a[o];if(u(e,t,r,n,s)){return false}}return true});var f=function(e){if(/.*\.json$/i.test(e)){return"JSON"}if(/.*\.xml$/i.test(e)){return"XML"}if(/.*metadata$/i.test(e)){return"XML"}return null};window.sinon.FakeXMLHttpRequest.prototype.respondFile=function(e,t,r){var n=u({url:r,dataType:"text"});if(!n.success){throw new Error("Could not load file from: "+r)}var s=n.data;var a=f(r);if(this["respond"+a]){this["respond"+a](e,t,s)}else{this.respond(e,t,s)}};window.sinon.FakeXMLHttpRequest.prototype.respondJSON=function(e,t,r){t=t||{};t["Content-Type"]=t["Content-Type"]||"application/json";this.respond(e,t,typeof r==="string"?r:JSON.stringify(r))};window.sinon.FakeXMLHttpRequest.prototype.respondXML=function(e,t,r){t=t||{};t["Content-Type"]=t["Content-Type"]||"application/xml";this.respond(e,t,r)};return i});